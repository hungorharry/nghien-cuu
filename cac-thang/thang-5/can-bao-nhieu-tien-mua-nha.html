<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Máy Tính Đầu Tư Chung Cư & Tài Chính Cá Nhân</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation/dist/chartjs-plugin-annotation.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px; color: #333;
        }
        .container {
            max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.95);
            border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px); overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white;
            padding: 30px; text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .calculator-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; padding: 30px; }
        .input-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; font-size: 1.1em; }
        .input-group input, .input-group select {
            width: 100%; padding: 12px; border: 2px solid #e1e8ed;
            border-radius: 8px; font-size: 1.1em; transition: border-color 0.3s ease;
        }
        .input-group select optgroup { font-weight: bold; color: #333; background: #f8f9fa; }
        .input-group select option { padding: 8px 12px; color: #666; }
        .input-group input:focus, .input-group select:focus {
            outline: none; border-color: #ff6b6b; box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }
        .currency { position: relative; }
        .currency::after {
            content: 'triệu VNĐ'; position: absolute; right: 12px; top: 50%;
            transform: translateY(-50%); color: #666; font-size: 0.9em; pointer-events: none;
        }
        .currency input { padding-right: 90px; }
        .results-card {
            background: linear-gradient(135deg, #74b9ff, #0984e3); color: white;
            border-radius: 15px; padding: 25px;
        }
        .result-item {
            background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px;
            margin-bottom: 15px; backdrop-filter: blur(5px);
        }
        .result-label { font-size: 0.9em; opacity: 0.8; margin-bottom: 5px; }
        .result-value { font-size: 1.4em; font-weight: bold; }
        
        .selected-project-info {
            grid-column: 1 / -1; 
            margin-top: 20px; padding: 20px; background: #f0f4f8; 
            border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.05);
            border-left: 5px solid #ff6b6b; 
        }
        .selected-project-info h3 { color: #ff6b6b; margin-bottom: 15px; text-align:center; font-size: 1.5em; }
        .selected-project-info div { font-size: 1.05em; margin-bottom: 8px; color: #34495e;}
        #selectedProjectName { font-size: 1.3em; font-weight: bold; margin-bottom: 10px; color: #2c3e50; }
        .star-rating { color: #f39c12; font-size: 1.2em; }
        .star-rating .far { color: #bdc3c7; }
        #selectedProjectContractorPast ul { list-style-type: disc; margin-left: 20px; padding-left: 5px;}
        #selectedProjectContractorPast li { margin-bottom: 3px;}

        .market-info {
            grid-column: 1 / -1; 
            background: linear-gradient(135deg, #fdcb6e, #e17055); 
            color: white; padding: 20px; border-radius: 15px; margin-top: 20px;
        }
        .market-info h3 { text-align: center; margin-bottom: 15px; font-size: 1.4em; }
        .market-segments { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .segment-card { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; }
        .segment-title { font-weight: bold; margin-bottom: 8px; font-size: 1.1em; }
        .segment-info { font-size: 0.9em; line-height: 1.4; }

        .timeline-section {
            grid-column: 1 / -1; background: linear-gradient(135deg, #00b894, #00cec9); color: white;
            border-radius: 15px; padding: 30px; margin-top: 20px;
        }
        .timeline-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 20px; }
        .timeline-item {
            background: rgba(255,255,255,0.15); padding: 20px; border-radius: 12px; text-align: center;
            backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); transition: transform 0.3s ease;
        }
        .timeline-item:hover { transform: translateY(-3px); background: rgba(255,255,255,0.2); }
        .timeline-year { font-size: 1.2em; font-weight: bold; color: #ffeaa7; margin-bottom: 10px; }
        .timeline-amount { font-size: 1.5em; font-weight: bold; margin-bottom: 5px; }
        .timeline-desc { font-size: 0.85em; opacity: 0.9; line-height: 1.5; }
        .charts-section {
            grid-column: 1 / -1; background: white; border-radius: 15px; padding: 40px;
            margin-top: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .charts-section h2 { text-align: center; margin-bottom: 20px; color: #333; font-size: 1.6em; }
        .chart-container { position: relative; height: 350px; width: 100%; margin-bottom: 30px; }
        .chart-container:last-child { margin-bottom: 0; }
        .house-options {
            grid-column: 1 / -1; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin-top: 20px;
        }
        .house-options h3.category-header { 
            display: flex; align-items: center; font-weight: bold; 
            text-transform: uppercase; letter-spacing: 1px; 
            grid-column: 1 / -1; 
        }
        .filter-btn { transition: all 0.3s ease; font-family: inherit; }
        .filter-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .filter-btn.active { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .house-card {
            background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, border 0.3s ease; cursor: pointer; border: 3px solid transparent;
        }
        .house-card:hover { transform: translateY(-5px); }
        .house-card.selected-for-chart { border-color: #ff6b6b !important; box-shadow: 0 12px 30px rgba(255, 107, 107, 0.3); }
        .house-card.affordable { border-left: 5px solid #00b894; }
        .house-card.stretch { border-left: 5px solid #fdcb6e; }
        .house-card.future { border-left: 5px solid #ff6b6b; }
        .house-card.house-luxury { border-left: 5px solid #6c5ce7 !important; }
        .house-card.selected-for-chart {
            border-left-width: 3px !important; border-top-width: 3px !important;
            border-right-width: 3px !important; border-bottom-width: 3px !important;
        }
        .house-title { font-size: 1.3em; font-weight: bold; margin-bottom: 10px; color: #333; }
        .house-price { font-size: 1.1em; color: #ff6b6b; font-weight: bold; margin-bottom: 10px; }
        .house-details { font-size: 0.9em; color: #666; line-height: 1.4; }
        .price-projection { font-size: 0.85em; color: #666; margin-top: 8px; font-style: italic; }
        .status-badge {
            display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;
            font-weight: bold; text-transform: uppercase; margin-top: 10px;
        }
        .status-green { background: #00b894; color: white; }
        .status-orange { background: #fdcb6e; color: #333; }
        .status-red { background: #ff6b6b; color: white; }
        .status-luxury-custom { background: #6c5ce7; color: white; }

        .guide-section {
            grid-column: 1 / -1; background: linear-gradient(135deg, #a8e6cf, #dcedc1); 
            border-radius: 15px; padding: 25px; margin-top: 20px;
            border: 2px solid #81c784;
        }
        .guide-toggle {
            background: linear-gradient(135deg, #4caf50, #388e3c); color: white; 
            border: none; padding: 12px 24px; border-radius: 25px; 
            font-size: 1.1em; font-weight: bold; cursor: pointer;
            transition: all 0.3s ease; margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        .guide-toggle:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4); }
        .guide-content { display: none; }
        .guide-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .guide-step { 
            background: rgba(255, 255, 255, 0.8); border-radius: 10px; 
            padding: 20px; margin-bottom: 15px; border-left: 4px solid #4caf50;
        }
        .guide-step h4 { color: #2e7d32; margin-bottom: 10px; font-size: 1.2em; }
        .guide-step ul { margin-left: 20px; }
        .guide-step li { margin-bottom: 8px; line-height: 1.5; }
        .guide-highlight { background: linear-gradient(135deg, #fff3e0, #ffe0b2); 
                          border: 2px solid #ff9800; border-radius: 8px; 
                          padding: 15px; margin: 15px 0; }
        .guide-tip { background: #e8f5e8; border-left: 4px solid #4caf50; 
                    padding: 12px; margin: 10px 0; border-radius: 5px; }
        .guide-warning { background: #fff3e0; border-left: 4px solid #ff9800; 
                        padding: 12px; margin: 10px 0; border-radius: 5px; }

        @media (max-width: 768px) {
            .calculator-section { grid-template-columns: 1fr; }
            .header h1 { font-size: 2em; }
            .timeline-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
            .timeline-item { padding: 15px; }
            .timeline-year { font-size: 1.1em; margin-bottom: 8px; }
            .timeline-amount { font-size: 1.2em; }
            .chart-container { height: 300px; }
            .market-segments { grid-template-columns: 1fr; }
            .guide-step { padding: 15px; }
            .guide-step h4 { font-size: 1.1em; }
            .guide-toggle { font-size: 1em; padding: 10px 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span style="font-size: 0.8em;">🏢</span> Máy Tính Đầu Tư Chung Cư & Tài Chính Cá Nhân</h1>
            <p>Tính toán khả năng mua chung cư với thu nhập của bạn (Tầm nhìn 2034) - <strong>Logic tăng giá thực tế theo phân khúc</strong></p>
        </div>
        
        <div class="calculator-section">
            <div class="input-card">
                <h2 style="margin-bottom: 20px; color: #ff6b6b;">📊 Thông Tin Thu Nhập & Chi Tiêu</h2>
                <div class="input-group"> <label for="salary">Lương hàng tháng:</label> <div class="currency"><input type="number" id="salary" value="10" min="1" max="1000"></div> </div>
                <div class="input-group"> <label for="expenses">Chi tiêu hàng tháng (hiện tại):</label> <div class="currency"><input type="number" id="expenses" value="4" min="1" max="500"></div> </div>
                <div class="input-group"> <label for="bonus">Thu nhập phụ (năm):</label> <div class="currency"><input type="number" id="bonus" value="20" min="0" max="1000"></div> </div>
                <div class="input-group"> <label for="current-savings">Tiết kiệm tiền mặt hiện tại:</label> <div class="currency"><input type="number" id="current-savings" value="0" min="0" max="10000"></div> </div>
                <div class="input-group"> <label for="initial-investment">Giá trị đầu tư hiện tại:</label> <div class="currency"><input type="number" id="initial-investment" value="0" min="0" max="10000"></div> </div>
                <div class="input-group"> <label for="dca-amount">Đầu tư DCA hàng tháng:</label> <div class="currency"><input type="number" id="dca-amount" value="0" min="0" max="500"></div> </div>
                
                <div class="input-group"> <label for="target-years">Thời gian mục tiêu:</label> <select id="target-years"> <optgroup label="🚀 Ngắn hạn"><option value="0.5">6 tháng</option><option value="1">1 năm</option><option value="1.5">1.5 năm</option><option value="2">2 năm</option></optgroup> <optgroup label="🎯 Trung hạn"><option value="2.5">2.5 năm</option><option value="3" selected>3 năm</option><option value="3.5">3.5 năm</option><option value="4">4 năm</option><option value="4.5">4.5 năm</option><option value="5">5 năm</option></optgroup> <optgroup label="🏃 Dài hạn"><option value="6">6 năm</option><option value="7">7 năm</option><option value="8">8 năm</option><option value="10">10 năm</option></optgroup> <optgroup label="🏆 Rất dài hạn (Đến 2034+)"><option value="12">12 năm</option><option value="15">15 năm</option><option value="20">20 năm</option></optgroup> </select> </div>
                
                <h3 style="margin-top: 25px; margin-bottom: 15px; color: #555; font-size: 1.3em;">📈 Tỷ Lệ Tăng Trưởng Hàng Năm</h3>
                <div class="input-group"> <label for="salary-growth">Tăng trưởng lương/năm (%):</label> <input type="number" id="salary-growth" value="5" min="0" max="20" step="0.5"> </div>
                <div class="input-group"> <label for="expenses-growth">Gia tăng chi tiêu/năm (%):</label> <input type="number" id="expenses-growth" value="3" min="0" max="20" step="0.5"> </div>
                <div class="input-group"> <label for="investment-growth">Tăng trưởng đầu tư/năm (%):</label> <input type="number" id="investment-growth" value="10" min="-20" max="50" step="0.5"> </div>
                <div style="background: linear-gradient(135deg, #ddd6fe, #c7d2fe); padding: 15px; border-radius: 10px; margin-top: 15px; font-size: 0.95em; color: #374151;">
                    <strong>💡 Tỷ lệ tăng giá BĐS:</strong> Được cố định 7%/năm cơ bản, tự động điều chỉnh theo phân khúc và thời gian để phản ánh thực tế thị trường TP.HCM.
                </div>
            </div>
            
            <div class="results-card">
                <h2 style="margin-bottom: 20px;">💰 Kết Quả Tính Toán</h2>
                <div class="result-item"><div class="result-label">Tiết kiệm ròng hàng tháng (sau DCA):</div><div class="result-value" id="monthly-net-savings">...</div></div>
                <div class="result-item"><div class="result-label">Tổng tích lũy sau <span id="years-display">3 năm</span> (Vốn tự có):</div><div class="result-value" id="total-savings">...</div></div>
                <div class="result-item"><div class="result-label">Giá trị danh mục đầu tư (cuối kỳ):</div><div class="result-value" id="final-investment-value">...</div></div>
                <div class="result-item"><div class="result-label">Khả năng vay ngân hàng (ước tính 70% giá trị nhà):</div><div class="result-value" id="loan-amount">...</div></div>
                <div class="result-item"><div class="result-label">Tổng giá trị chung cư có thể mua (sau <span id="years-display-3">3 năm</span>):</div><div class="result-value" id="house-budget">...</div></div>
                <div class="result-item"><div class="result-label">Tỷ lệ tiết kiệm (so với lương, trước DCA):</div><div class="result-value" id="savings-rate">...</div></div>
                <div class="result-item"><div class="result-label">⚠️ Giá chung cư 1.5 tỷ hôm nay sau <span id="years-display-2">3 năm</span> (tăng theo mô hình thực tế):</div><div class="result-value" id="future-house-price">...</div></div>
                <div class="result-item"><div class="result-label">🏢 Số dự án chung cư có thể mua (trong 57):</div><div class="result-value" id="affordable-count">...</div></div>
                <div class="result-item"><div class="result-label">🎯 Khuyến nghị cho bạn:</div><div class="result-value" id="recommendation" style="font-size: 1em; line-height: 1.4;">...</div></div>
                <div class="result-item"> <div class="result-label">📊 Tiến độ đến chung cư khả thi đầu tiên (trả trước):</div> <div style="background: rgba(255,255,255,0.2); border-radius: 10px; height: 20px; margin: 10px 0; overflow: hidden;"> <div id="progress-bar" style="height: 100%; background: linear-gradient(90deg, #00b894, #00cec9); border-radius: 10px; transition: width 0.5s ease; width: 0%;"></div> </div> <div class="result-value" id="progress-text" style="font-size: 0.9em;">...</div> </div>
            </div>
            
            <div class="guide-section">
                <button class="guide-toggle" onclick="toggleGuide()">
                    📚 Hướng Dẫn Sử Dụng Chi Tiết
                </button>
                
                <div class="guide-content" id="guideContent">
                    <div class="guide-highlight">
                        <h3 style="color: #e65100; margin-bottom: 15px;">🎯 Mục Đích của Máy Tính</h3>
                        <p>Giúp bạn lập kế hoạch tài chính thực tế để mua chung cư tại TP.HCM và vùng phụ cận. Máy tính sử dụng <strong>mô hình tăng giá BĐS thực tế</strong> - phân khúc khác nhau có tốc độ tăng giá khác nhau!</p>
                    </div>

                    <div class="guide-step">
                        <h4>🔢 Bước 1: Nhập Thông Tin Thu Nhập & Chi Tiêu</h4>
                        <ul>
                            <li><strong>Lương hàng tháng:</strong> Thu nhập chính từ công việc (triệu VNĐ)</li>
                            <li><strong>Chi tiêu hàng tháng:</strong> Tổng chi phí sinh hoạt, ăn uống, di chuyển hiện tại</li>
                            <li><strong>Thu nhập phụ (năm):</strong> Thưởng Tết, làm thêm, freelance...</li>
                            <li><strong>Tiết kiệm tiền mặt hiện tại:</strong> Số tiền có sẵn trong tài khoản</li>
                            <li><strong>Giá trị đầu tư hiện tại:</strong> Cổ phiếu, quỹ, vàng, crypto đang sở hữu</li>
                            <li><strong>Đầu tư DCA hàng tháng:</strong> Số tiền định kỳ bỏ vào đầu tư (Dollar Cost Averaging)</li>
                        </ul>
                        <div class="guide-tip">
                            💡 <strong>Mẹo:</strong> Hãy ước tính thật và hơi bi quan một chút để kế hoạch thực tế hơn!
                        </div>
                    </div>

                    <div class="guide-step">
                        <h4>⏰ Bước 2: Chọn Thời Gian Mục Tiêu</h4>
                        <ul>
                            <li><strong>Ngắn hạn (6 tháng - 2 năm):</strong> Phù hợp nếu đã có vốn, cần thời gian chuẩn bị</li>
                            <li><strong>Trung hạn (2.5 - 5 năm):</strong> Lựa chọn phổ biến, cân bằng giữa tích lũy và tăng giá</li>
                            <li><strong>Dài hạn (6+ năm):</strong> Cho người trẻ, có thời gian tích lũy từ từ</li>
                        </ul>
                        <div class="guide-warning">
                            ⚠️ <strong>Lưu ý:</strong> Thời gian càng dài, giá chung cư càng tăng nhiều!
                        </div>
                    </div>

                    <div class="guide-step">
                        <h4>📈 Bước 3: Điều Chỉnh Tỷ Lệ Tăng Trưởng</h4>
                        <ul>
                            <li><strong>Tăng trưởng lương:</strong> 3-7%/năm là hợp lý (tùy ngành nghề)</li>
                            <li><strong>Gia tăng chi tiêu:</strong> 2-4%/năm (lạm phát + nâng cấp đời sống)</li>
                            <li><strong>Tăng trưởng đầu tư:</strong> 8-12%/năm (cổ phiếu), 5-7%/năm (quỹ an toàn)</li>
                        </ul>
                        <div class="guide-tip">
                            💡 <strong>Mẹo:</strong> Tỷ lệ tăng giá BĐS đã được cố định theo nghiên cứu thị trường thực tế!
                        </div>
                    </div>

                    <div class="guide-step">
                        <h4>📊 Bước 4: Đọc Hiểu Kết Quả</h4>
                        <ul>
                            <li><strong>Tiết kiệm ròng hàng tháng:</strong> Số tiền có thể tích lũy mỗi tháng sau khi trừ DCA</li>
                            <li><strong>Tổng tích lũy:</strong> Tổng tài sản (tiền mặt + đầu tư) sau thời gian mục tiêu</li>
                            <li><strong>Khả năng vay:</strong> Ước tính vay 70% giá trị nhà</li>
                            <li><strong>Tổng giá trị chung cư có thể mua:</strong> Vốn tự có + Khả năng vay</li>
                            <li><strong>Số dự án có thể mua:</strong> Trong tổng số 57 dự án đã khảo sát</li>
                        </ul>
                    </div>

                    <div class="guide-step">
                        <h4>🏢 Bước 5: Khám Phá Các Dự Án Chung Cư</h4>
                        <ul>
                            <li><strong>💚 Bình dân (18 dự án):</strong> Dưới 1.8 tỷ - Nhiều tại Hóc Môn, Bình Chánh, Q12</li>
                            <li><strong>🟡 Trung cấp (16 dự án):</strong> 1.8-3.5 tỷ - Phân khúc chính, vị trí tốt</li>
                            <li><strong>🔴 Cao cấp (13 dự án):</strong> 3.2-6 tỷ - Thủ Thiêm, Q1, Q2...</li>
                            <li><strong>💎 Luxury (11 dự án):</strong> Trên 6.5 tỷ - Siêu sang, branded residences</li>
                        </ul>
                        <div class="guide-tip">
                            💡 <strong>Cách sử dụng:</strong> Click vào từng dự án để xem chi tiết và hiển thị trên biểu đồ!
                        </div>
                    </div>

                    <div class="guide-step">
                        <h4>🎨 Bước 6: Phân Tích Biểu Đồ</h4>
                        <ul>
                            <li><strong>Biểu đồ 1:</strong> Theo dõi tăng trưởng lương vs chi tiêu vs tiết kiệm</li>
                            <li><strong>Biểu đồ 2:</strong> Lộ trình tích lũy so với mục tiêu mua nhà</li>
                            <li><strong>Đường giá dự án:</strong> Hiện khi click chọn dự án cụ thể</li>
                            <li><strong>Vùng giá:</strong> Min-Max price của dự án theo thời gian</li>
                        </ul>
                    </div>

                    <div class="guide-step">
                        <h4>⚡ Mô Hình Tăng Giá BĐS Thực Tế</h4>
                        <ul>
                            <li><strong>💚 Bình dân:</strong> Tăng nhanh nhất (~10.5%/năm) - Khan hiếm đất</li>
                            <li><strong>🟡 Trung cấp:</strong> Tăng ổn định (~8.4%/năm) - Phân khúc chính</li>
                            <li><strong>🔴 Cao cấp:</strong> Tăng chậm hơn (~6.0%/năm) - Thị trường nhỏ</li>
                            <li><strong>💎 Luxury:</strong> Tăng chậm nhất (~4.2%/năm) - Biến động lớn</li>
                        </ul>
                        <div class="guide-warning">
                            ⚠️ <strong>Quan trọng:</strong> Tỷ lệ này giảm dần theo thời gian (diminishing returns)
                        </div>
                    </div>

                    <div class="guide-highlight">
                        <h4 style="color: #e65100; margin-bottom: 15px;">🎯 Lời Khuyên Đầu Tư Thông Minh</h4>
                        <ul style="margin-left: 0; padding-left: 20px;">
                            <li><strong>Tăng thu nhập:</strong> Học thêm kỹ năng, chuyển việc, làm thêm</li>
                            <li><strong>Kiểm soát chi tiêu:</strong> Lập budget, cắt giảm chi phí không cần thiết</li>
                            <li><strong>Đầu tư DCA:</strong> Đầu tư định kỳ vào ETF, cổ phiếu blue-chip</li>
                            <li><strong>Mua sớm hơn:</strong> Giá BĐS tăng liên tục, càng chờ càng khó</li>
                            <li><strong>Chọn vị trí:</strong> Ưu tiên gần giao thông công cộng, trường học</li>
                            <li><strong>Pháp lý:</strong> Kiểm tra kỹ sổ đỏ, giấy phép xây dựng</li>
                        </ul>
                    </div>

                    <div class="guide-tip" style="text-align: center; font-size: 1.1em;">
                        🎯 <strong>Mục tiêu:</strong> Giúp bạn có kế hoạch tài chính thực tế để sở hữu ngôi nhà mơ ước! 
                        <br>💪 <strong>Hành động:</strong> Bắt đầu tiết kiệm và đầu tư từ hôm nay!
                    </div>
                </div>
            </div>

            <div class="market-info">
                <h3>📈 Mô Hình Tăng Giá Thực Tế Theo Phân Khúc</h3>
                <div class="market-segments">
                    <div class="segment-card">
                        <div class="segment-title">💚 Bình Dân</div>
                        <div class="segment-info" id="affordable-rate">Tăng <span id="affordable-growth">9.0</span>%/năm<br>Lý do: Khan hiếm đất, nhu cầu cao</div>
                    </div>
                    <div class="segment-card">
                        <div class="segment-title">🟡 Trung Cấp</div>
                        <div class="segment-info" id="mid-rate">Tăng <span id="mid-growth">7.0</span>%/năm<br>Lý do: Phân khúc chính, ổn định</div>
                    </div>
                    <div class="segment-card">
                        <div class="segment-title">🔴 Cao Cấp</div>
                        <div class="segment-info" id="high-rate">Tăng <span id="high-growth">5.0</span>%/năm<br>Lý do: Thị trường nhỏ hơn</div>
                    </div>
                    <div class="segment-card">
                        <div class="segment-title">💎 Luxury</div>
                        <div class="segment-info" id="luxury-rate">Tăng <span id="luxury-growth">3.5</span>%/năm<br>Lý do: Thị trường rất nhỏ, biến động</div>
                    </div>
                </div>
                <p style="text-align: center; margin-top: 15px; font-size: 0.9em; opacity: 0.9;">
                    * Tỷ lệ tăng giảm dần theo thời gian để phản ánh thực tế thị trường
                </p>
            </div>
            
            <div class="selected-project-info" id="selectedProjectInfoCard" style="display: none;">
                <h3>🏗️ Thông Tin Chung Cư Đang Chọn</h3>
                <div id="selectedProjectName" style="font-size: 1.5em; color: #007bff; margin-bottom:15px;"></div>
                <div><strong>Chủ đầu tư:</strong> <span id="selectedProjectDeveloper"></span></div>
                <div><strong>Tình trạng:</strong> <span id="selectedProjectStatus"></span></div>
                <div><strong>Đặc điểm nổi bật:</strong> <span id="selectedProjectFeatures"></span></div>
                <h4 style="margin-top: 20px; margin-bottom: 10px; color: #28a745;">Thông Tin Nhà Thầu Chính</h4>
                <div><strong>Tên nhà thầu:</strong> <span id="selectedProjectContractorName"></span></div>
                <div><strong>Đánh giá uy tín:</strong> <span id="selectedProjectContractorRating" class="star-rating"></span></div>
                <div style="margin-top: 5px;"><strong>Một số dự án đã thực hiện:</strong> <div id="selectedProjectContractorPast" style="margin-left: 20px; font-size:0.95em;"></div></div>
                <div style="margin-top: 5px;"><strong>Nhận xét chung:</strong> <span id="selectedProjectContractorFeedback" style="font-style: italic;"></span></div>
            </div>

            <div class="timeline-section">
                <h2 style="text-align: center; margin-bottom: 10px;">📈 Lộ Trình Tích Lũy Mua Chung Cư</h2>
                <p style="text-align: center; opacity: 0.9;">Dự báo số tiền tích lũy được theo từng năm (Tiền mặt + Đầu tư)</p>
                <div id="quick-tip" style="background: linear-gradient(135deg, rgb(85, 163, 255), rgb(0, 61, 130)); color: white; padding: 15px; border-radius: 10px; margin: 15px 0px; font-size: 0.9em; line-height: 1.4;">...</div>
                <div class="timeline-grid" id="timeline-grid"></div>
            </div>

                <div class="charts-section">
                <h2 style="font-size: 1.8em;">📊 Biểu Đồ Phân Tích Tài Chính</h2>
                <div class="chart-container"><h3 style="text-align:center; margin-bottom:10px; color: #555;">Tăng Trưởng Lương, Chi Tiêu & Tiết Kiệm Ròng Tháng</h3><canvas id="salaryGrowthChart"></canvas></div>
                <div class="chart-container"><h3 style="text-align:center; margin-bottom:10px; color: #555;">Lộ Trình Đạt Mục Tiêu Mua Chung Cư (Tổng Tài Sản)</h3><canvas id="savingsGoalChart"></canvas></div>
            </div>
            
            <div class="house-options">
                <h2 style="grid-column: 1 / -1; text-align: center; margin-bottom: 20px; color: #333; font-size: 1.8em;">🏢 57 Dự Án Chung Cư Đa Dạng (Click để xem chi tiết & biểu đồ)</h2>
                <div style="grid-column: 1 / -1; background: linear-gradient(135deg, #fdcb6e, #e17055); color: white; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 20px;"><strong>⚠️ LƯU Ý:</strong> Giá chung cư tăng theo mô hình thực tế - phân khúc khác nhau có tốc độ tăng khác nhau!</div>
                <div style="grid-column: 1 / -1; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 30px;">
                    <button class="filter-btn active" onclick="filterHouses('all')" style="padding: 8px 16px; border: none; border-radius: 20px; background: #74b9ff; color: white; cursor: pointer; font-weight: bold;">Tất cả (57)</button>
                    <button class="filter-btn" onclick="filterHouses('affordable')" style="padding: 8px 16px; border: none; border-radius: 20px; background: #00b894; color: white; cursor: pointer;">Bình dân (18)</button>
                    <button class="filter-btn" onclick="filterHouses('mid')" style="padding: 8px 16px; border: none; border-radius: 20px; background: #fdcb6e; color: #333; cursor: pointer;">Trung cấp (16)</button>
                    <button class="filter-btn" onclick="filterHouses('high')" style="padding: 8px 16px; border: none; border-radius: 20px; background: #ff6b6b; color: white; cursor: pointer;">Cao cấp (13)</button>
                    <button class="filter-btn" onclick="filterHouses('luxury')" style="padding: 8px 16px; border: none; border-radius: 20px; background: #6c5ce7; color: white; cursor: pointer;">Luxury (11)</button>
                </div>
                <h3 class="category-header affordable-category" style="color: #00b894; font-size: 1.4em; margin: 20px 0 10px 0; border-bottom: 2px solid #00b894; padding-bottom: 10px;">💚 CHUNG CƯ BÌNH DÂN (Dưới 1.8 tỷ)</h3>
                <h3 class="category-header mid-category" style="color: #fdcb6e; font-size: 1.4em; margin: 30px 0 10px 0; border-bottom: 2px solid #fdcb6e; padding-bottom: 10px;">🟡 CHUNG CƯ TRUNG CẤP (1.8 - 3.5 tỷ)</h3>
                <h3 class="category-header high-category" style="color: #ff6b6b; font-size: 1.4em; margin: 30px 0 10px 0; border-bottom: 2px solid #ff6b6b; padding-bottom: 10px;">🔴 CHUNG CƯ CAO CẤP (3.2 - 6 tỷ)</h3>
                <h3 class="category-header luxury-category" style="color: #6c5ce7; font-size: 1.4em; margin: 30px 0 10px 0; border-bottom: 2px solid #6c5ce7; padding-bottom: 10px;">💎 CHUNG CƯ LUXURY (Trên 6.5 tỷ)</h3>
            </div>
        </div>
    </div>

    <script>
        const PROJECTS_DATA = [
            // Dự án bình dân
            { id: 1, name: 'Chung Cư Bình An (B.Dương)', minPrice: 800, maxPrice: 1200, downPaymentRate: 0.2, segment: 'affordable', developer: 'Vạn Xuân Group (Ví dụ)', contractor: 'Xây Dựng ABC', contractorRating: 3, status: 'Đang mở bán', keyFeatures: 'Tiện ích cơ bản, gần KCN.', contractorInfo: { name: 'Xây Dựng ABC', rating: 3, pastProjects: ['KDC XYZ'], feedbackSummary: 'Chất lượng khá.'}},
            { id: 2, name: 'Chung Cư Harmony (L.Bình)', minPrice: 1200, maxPrice: 1600, downPaymentRate: 0.2, segment: 'affordable', developer: 'Nam Long Group (Ví dụ)', contractor: 'An Gia Land Construction', contractorRating: 4, status: 'Đã bàn giao một phần', keyFeatures: 'Không gian xanh, gần trường học.', contractorInfo: { name: 'An Gia Land Construction', rating: 4, pastProjects: ['Flora Kikyo'], feedbackSummary: 'Uy tín, chất lượng tốt.'}},
            { id: 3, name: 'Chung Cư Riverview (N.Trạch)', minPrice: 900, maxPrice: 1400, downPaymentRate: 0.2, segment: 'affordable', developer: 'Địa Ốc Hoàng Quân (Ví dụ)', contractor: 'Địa Ốc Hoàng Quân (Tự xây)', contractorRating: 3, status: 'Đang xây dựng', keyFeatures: 'Giá cạnh tranh, tiềm năng khu vực.', contractorInfo: { name: 'Địa Ốc Hoàng Quân', rating: 3, pastProjects: ['HQC Plaza'], feedbackSummary: 'Kinh nghiệm NOXH.'}},
            { id: 4, name: 'Citi Esto (Cát Lái)', minPrice: 1500, maxPrice: 1750, downPaymentRate: 0.3, segment: 'affordable', developer: 'Kiến Á', contractor: 'COSACO', contractorRating: 3, status: 'Đã bàn giao', keyFeatures: 'KĐT Cát Lái, giá tốt.', contractorInfo: { name: 'COSACO', rating: 3, pastProjects:['Nhiều dự án Kiến Á'], feedbackSummary: 'Kinh nghiệm với phân khúc tầm trung.'}},
            { id: 5, name: 'Ehome Southgate (Long An)', minPrice: 1000, maxPrice: 1300, downPaymentRate: 0.2, segment: 'affordable', developer: 'Nam Long Group', contractor: 'Nam Khang', contractorRating: 3, status: 'Đang bàn giao', keyFeatures: 'Thuộc KĐT Waterpoint, giá dễ chịu.', contractorInfo: { name: 'Nam Khang', rating: 3, pastProjects:['Ehome 3, 4'], feedbackSummary: 'Chuyên dòng Ehome.'}},
            { id: 6, name: 'Tecco Town Bình Tân', minPrice: 1400, maxPrice: 1700, downPaymentRate: 0.2, segment: 'affordable', developer: 'Tecco Group', contractor: 'Tecco (Tự xây)', contractorRating: 3, status: 'Đã bàn giao', keyFeatures: 'Nhiều block, quy mô lớn.', contractorInfo: { name: 'Tecco Group', rating: 3, pastProjects:['Nhiều dự án Tecco'], feedbackSummary: 'Giá rẻ, chất lượng tương đối.'}},
            { id: 7, name: 'Dream Home Riverside (Q8)', minPrice: 1600, maxPrice: 1900, downPaymentRate: 0.3, segment: 'affordable', developer: 'Nhà Mơ', contractor: 'An Phong (GĐ1)', contractorRating: 4, status: 'Đã bàn giao', keyFeatures: 'View sông, tiện ích khá.', contractorInfo: { name: 'An Phong', rating: 4, pastProjects:['Nhiều dự án lớn'], feedbackSummary: 'Nhà thầu tốt.'}},
            { id: 8, name: 'Legacy Prime (Thuận An, BD)', minPrice: 900, maxPrice: 1100, downPaymentRate: 0.2, segment: 'affordable', developer: 'Kim Oanh Group', contractor: 'Hòa Bình Corp', contractorRating: 5, status: 'Đang xây', keyFeatures: 'Giá rẻ nhất Bình Dương hiện tại.', contractorInfo: { name: 'Hòa Bình Corp', rating: 5, pastProjects:['Saigon Centre'], feedbackSummary: 'Thương hiệu lớn.'}},
            { id: 9, name: 'Bcons Plaza (Dĩ An, BD)', minPrice: 1300, maxPrice: 1500, downPaymentRate: 0.2, segment: 'affordable', developer: 'Bcons', contractor: 'Bcons (Tự xây)', contractorRating: 3, status: 'Đã bàn giao', keyFeatures: 'Giá tốt, gần Làng ĐHQG.', contractorInfo: { name: 'Bcons', rating: 3, pastProjects:['Dòng Bcons'], feedbackSummary: 'Nhanh, gọn, giá rẻ.'}},
            { id: 10, name: 'Phú Đông Sky Garden (Dĩ An, BD)', minPrice: 1700, maxPrice: 2000, downPaymentRate: 0.3, segment: 'affordable', developer: 'Phú Đông Group', contractor: 'Phú Đông (Tự xây)', contractorRating: 4, status: 'Sắp bàn giao', keyFeatures: 'Chất lượng khá, thiết kế đẹp.', contractorInfo: { name: 'Phú Đông Group', rating: 4, pastProjects:['Phú Đông Premier'], feedbackSummary: 'Uy tín trong phân khúc.'}},
            
            // Thêm dự án ở Hóc Môn, Bình Chánh, Quận 12
            { id: 45, name: 'Green Star Sky Garden (Hóc Môn)', minPrice: 1100, maxPrice: 1400, downPaymentRate: 0.2, segment: 'affordable', developer: 'Hưng Thịnh Land', contractor: 'Hưng Thịnh Cons', contractorRating: 4, status: 'Đang mở bán', keyFeatures: 'Gần Metro Line 1, tiện ích đầy đủ.', contractorInfo: { name: 'Hưng Thịnh Cons', rating: 4, pastProjects: ['Q7 Boulevard'], feedbackSummary: 'Kinh nghiệm tốt, thi công nhanh.'}},
            { id: 46, name: 'Lovera Vista (Bình Chánh)', minPrice: 1300, maxPrice: 1600, downPaymentRate: 0.2, segment: 'affordable', developer: 'Khang Điền', contractor: 'Khang Điền (Tự xây)', contractorRating: 4, status: 'Đã bàn giao', keyFeatures: 'KĐT Lovera Park, hệ thống trường học tốt.', contractorInfo: { name: 'Khang Điền', rating: 4, pastProjects: ['Lovera Premier'], feedbackSummary: 'Uy tín, chất lượng ổn định.'}},
            { id: 47, name: 'Opal Cityview (Q12)', minPrice: 1500, maxPrice: 1800, downPaymentRate: 0.2, segment: 'affordable', developer: 'Dat Xanh Group', contractor: 'Ricons', contractorRating: 4, status: 'Đang bàn giao', keyFeatures: 'Gần Quận 1, kết nối tốt các quận trung tâm.', contractorInfo: { name: 'Ricons', rating: 4, pastProjects: ['The Sun Avenue'], feedbackSummary: 'Chất lượng tốt, uy tín.'}},
            { id: 48, name: 'Westgate (Bình Chánh)', minPrice: 1200, maxPrice: 1500, downPaymentRate: 0.2, segment: 'affordable', developer: 'An Gia Investment', contractor: 'An Gia Construction', contractorRating: 4, status: 'Đang xây dựng', keyFeatures: 'Tiện ích đa dạng, gần AEON Mall.', contractorInfo: { name: 'An Gia Construction', rating: 4, pastProjects: ['The Manor'], feedbackSummary: 'Nhà thầu chuyên nghiệp.'}},
            { id: 49, name: 'Vinhomes Smart City (Hóc Môn)', minPrice: 1800, maxPrice: 2200, downPaymentRate: 0.2, segment: 'mid', developer: 'Vinhomes', contractor: 'Coteccons', contractorRating: 5, status: 'Sắp mở bán', keyFeatures: 'Smart home, tiện ích 5 sao Vinhomes.', contractorInfo: { name: 'Coteccons', rating: 5, pastProjects: ['Vinhomes Grand Park'], feedbackSummary: 'Chất lượng hàng đầu.'}},
            { id: 50, name: 'Saigon Mystery Villas (Q12)', minPrice: 1600, maxPrice: 1900, downPaymentRate: 0.3, segment: 'affordable', developer: 'Hưng Thịnh Corp', contractor: 'Hưng Thịnh Incons', contractorRating: 4, status: 'Đang bàn giao', keyFeatures: 'Thiết kế hiện đại, gần BV Chợ Rẫy 2.', contractorInfo: { name: 'Hưng Thịnh Incons', rating: 4, pastProjects: ['Q7 Saigon Riverside'], feedbackSummary: 'Thi công chất lượng.'}},
            { id: 51, name: 'Mizuki Park (Bình Chánh)', minPrice: 2000, maxPrice: 2500, downPaymentRate: 0.3, segment: 'mid', developer: 'Nam Long & Hankyu', contractor: 'Coteccons', contractorRating: 5, status: 'Đã bàn giao một phần', keyFeatures: 'KĐT kiểu Nhật, công viên 12ha.', contractorInfo: { name: 'Coteccons', rating: 5, pastProjects: ['Akari City'], feedbackSummary: 'Chất lượng cao, uy tín.'}},
            { id: 52, name: 'Dragon Riverside (Hóc Môn)', minPrice: 1400, maxPrice: 1700, downPaymentRate: 0.2, segment: 'affordable', developer: 'Phát Đạt Corp', contractor: 'Phát Đạt Cons', contractorRating: 3, status: 'Đang xây dựng', keyFeatures: 'View sông, giá cạnh tranh.', contractorInfo: { name: 'Phát Đạt Cons', rating: 3, pastProjects: ['Astral City'], feedbackSummary: 'Đang cải thiện chất lượng.'}},
            { id: 53, name: 'Jamila Khang Điền (Q9)', minPrice: 2200, maxPrice: 2800, downPaymentRate: 0.3, segment: 'mid', developer: 'Khang Điền', contractor: 'An Phong', contractorRating: 4, status: 'Đã bàn giao', keyFeatures: 'Thiết kế Malaysia, tiện ích resort.', contractorInfo: { name: 'An Phong', rating: 4, pastProjects: ['Safira Khang Điền'], feedbackSummary: 'Chất lượng ổn định.'}},
            { id: 54, name: 'Terra Rosa (Bình Chánh)', minPrice: 1900, maxPrice: 2300, downPaymentRate: 0.2, segment: 'mid', developer: 'Khang Điền', contractor: 'Khang Điền (Tự xây)', contractorRating: 4, status: 'Sắp mở bán', keyFeatures: 'Phong cách Địa Trung Hải, gần Metro.', contractorInfo: { name: 'Khang Điền', rating: 4, pastProjects: ['Lovera Vista'], feedbackSummary: 'Nhà thầu uy tín lâu năm.'}},
            { id: 55, name: 'Park View City (Q12)', minPrice: 1700, maxPrice: 2100, downPaymentRate: 0.2, segment: 'mid', developer: 'Hoàng Quân', contractor: 'Hoàng Quân (Tự xây)', contractorRating: 3, status: 'Đang bàn giao', keyFeatures: 'Gần công viên lớn, giá hợp lý.', contractorInfo: { name: 'Hoàng Quân', rating: 3, pastProjects: ['HQC Plaza'], feedbackSummary: 'Chuyên NOXH và tầm trung.'}},
            { id: 56, name: 'Sky Center (Hóc Môn)', minPrice: 1600, maxPrice: 2000, downPaymentRate: 0.2, segment: 'affordable', developer: 'Đất Xanh Group', contractor: 'Ricons', contractorRating: 4, status: 'Đang xây dựng', keyFeatures: 'Trung tâm Hóc Môn, kết nối thuận tiện.', contractorInfo: { name: 'Ricons', rating: 4, pastProjects: ['Opal Riverside'], feedbackSummary: 'Kinh nghiệm tốt với dự án tầm trung.'}},
            { id: 57, name: 'Green Valley (Bình Chánh)', minPrice: 1800, maxPrice: 2200, downPaymentRate: 0.3, segment: 'mid', developer: 'Novaland', contractor: 'Ricons', contractorRating: 4, status: 'Sắp bàn giao', keyFeatures: 'Thiết kế xanh, gần trường quốc tế.', contractorInfo: { name: 'Ricons', rating: 4, pastProjects: ['Aqua City'], feedbackSummary: 'Chất lượng ổn định.'}},
            
            // Dự án trung cấp
            { id: 11, name: 'Happy One Central (BD)', minPrice: 1800, maxPrice: 2200, downPaymentRate: 0.2, segment: 'mid', developer: 'Vạn Xuân Group', contractor: 'Central Cons', contractorRating: 4, status: 'Đang xây dựng', keyFeatures: '68 tiện ích trên không, cầu kính.', contractorInfo: { name: 'Central Cons', rating: 4, pastProjects: ['Kingdom 101'], feedbackSummary: 'Nhà thầu trẻ, năng động.'}},
            { id: 12, name: 'Aqua Bay Residences (Ví dụ)', minPrice: 2100, maxPrice: 2800, downPaymentRate: 0.2, segment: 'mid', developer: 'Novaland (Ví dụ)', contractor: 'Ricons (Ví dụ)', contractorRating: 4, status: 'Đang xây dựng', keyFeatures: 'View sông, thiết kế hiện đại.', contractorInfo: { name: 'Ricons', rating: 4, pastProjects:['Aqua City'], feedbackSummary: 'Kinh nghiệm tốt.'}},
            { id: 13, name: 'Sky Garden Apartments (Ví dụ)', minPrice: 2500, maxPrice: 3500, downPaymentRate: 0.2, segment: 'mid', developer: 'Hưng Thịnh Corp (Ví dụ)', contractor: 'Hưng Thịnh Incons', contractorRating: 4, status: 'Sắp mở bán', keyFeatures: 'Gần trục đường lớn.', contractorInfo: { name: 'Hưng Thịnh Incons', rating: 4, pastProjects:['Q7 SG Riverside'], feedbackSummary: 'Thi công nhanh.'}},
            { id: 14, name: 'Akari City (Bình Tân)', minPrice: 2800, maxPrice: 3400, downPaymentRate: 0.3, segment: 'mid', developer: 'Nam Long, Hankyu, NNR', contractor: 'Coteccons (GĐ1)', contractorRating: 5, status: 'GĐ 1 đã bàn giao, GĐ 2 đang xây', keyFeatures: 'KĐT kiểu Nhật, tiện ích đủ đầy.', contractorInfo: { name: 'Coteccons', rating: 5, pastProjects:['Landmark 81'], feedbackSummary: 'Top đầu VN.'}},
            { id: 15, name: 'Flora Panorama (Mizuki Park)', minPrice: 3000, maxPrice: 3800, downPaymentRate: 0.3, segment: 'mid', developer: 'Nam Long, Hankyu, NNR', contractor: 'Newtecons (Ví dụ)', contractorRating: 4, status: 'Đang xây', keyFeatures: 'View sông, KĐT Mizuki tiện ích.', contractorInfo: { name: 'Newtecons', rating: 4, pastProjects:['Nhiều dự án Masterise'], feedbackSummary: 'Chất lượng cao.'}},
            { id: 16, name: 'Celesta Rise (Nhà Bè)', minPrice: 3300, maxPrice: 4000, downPaymentRate: 0.3, segment: 'mid', developer: 'Keppel Land & Phú Long', contractor: 'Hòa Bình Corp', contractorRating: 5, status: 'Đang xây', keyFeatures: 'Tiêu chuẩn Singapore, nhiều mảng xanh.', contractorInfo: { name: 'Hòa Bình Corp', rating: 5, pastProjects:['Celesta Heights'], feedbackSummary: 'Uy tín, chất lượng.'}},
            { id: 17, name: 'The Privia (Bình Tân)', minPrice: 2900, maxPrice: 3500, downPaymentRate: 0.3, segment: 'mid', developer: 'Khang Điền', contractor: 'An Phong (Ví dụ)', contractorRating: 4, status: 'Sắp bàn giao', keyFeatures: 'Khang Điền uy tín, pháp lý tốt.', contractorInfo: { name: 'An Phong', rating: 4, pastProjects:['Nhiều dự án lớn'], feedbackSummary: 'Có kinh nghiệm.'}},
            { id: 18, name: 'Urban Green (Thủ Đức)', minPrice: 3500, maxPrice: 4200, downPaymentRate: 0.3, segment: 'mid', developer: 'Kusto Home', contractor: 'Coteccons', contractorRating: 5, status: 'Đang xây', keyFeatures: 'Thiết kế xanh, gần QL13.', contractorInfo: { name: 'Coteccons', rating: 5, pastProjects:['The MarQ'], feedbackSummary: 'Chất lượng hàng đầu.'}},
            { id: 19, name: 'King Crown Infinity (Thủ Đức)', minPrice: 4000, maxPrice: 5000, downPaymentRate: 0.3, segment: 'mid', developer: 'BCG Land', contractor: 'Tracodi & CC1', contractorRating: 3, status: 'Đang xây', keyFeatures: 'Vị trí Võ Văn Ngân, thiết kế độc đáo.', contractorInfo: { name: 'Tracodi & CC1', rating: 3, pastProjects:['Amor Residence'], feedbackSummary: 'Đang nỗ lực.'}},
            { id: 20, name: 'Precia (Thủ Đức)', minPrice: 3400, maxPrice: 4000, downPaymentRate: 0.3, segment: 'mid', developer: 'Điền Phúc Thành (Rio Land PT)', contractor: 'Phước Thành', contractorRating: 3, status: 'Đã bàn giao', keyFeatures: 'Gần sông, số lượng căn ít.', contractorInfo: { name: 'Phước Thành', rating: 3, pastProjects:['Centana TĐ'], feedbackSummary: 'Có kinh nghiệm khu vực.'}},
            
            // Dự án cao cấp
            { id: 21, name: 'Vinhomes Sapphire (Grand Park)', minPrice: 3200, maxPrice: 4200, downPaymentRate: 0.2, segment: 'high', developer: 'Vinhomes', contractor: 'Coteccons / Hòa Bình', contractorRating: 5, status: 'Đã bàn giao', keyFeatures: 'Đại đô thị, gần Metro.', contractorInfo: { name: 'Coteccons / Hòa Bình', rating: 5, pastProjects: ['Landmark 81'], feedbackSummary: 'Top đầu Việt Nam.'}},
            { id: 22, name: 'Masteri Lumiere Riverside (TPTĐ)', minPrice: 4800, maxPrice: 6500, downPaymentRate: 0.3, segment: 'high', developer: 'Masterise Homes', contractor: 'Newtecons', contractorRating: 5, status: 'Đã bàn giao', keyFeatures: 'Vị trí An Phú, ven sông.', contractorInfo: { name: 'Newtecons', rating: 5, pastProjects:['Masteri Centre Point'], feedbackSummary: 'Chất lượng cao cấp.'}},
            { id: 23, name: 'The Opus One (Global City)', minPrice: 5500, maxPrice: 7000, downPaymentRate: 0.3, segment: 'high', developer: 'Masterise Homes', contractor: 'An Phong', contractorRating: 4, status: 'Đang xây dựng', keyFeatures: 'Trong KĐT The Global City.', contractorInfo: { name: 'An Phong', rating: 4, pastProjects:['Celesta Rise'], feedbackSummary: 'Kinh nghiệm dự án lớn.'}},
            { id: 24, name: 'Palm Heights (Palm City)', minPrice: 4000, maxPrice: 5500, downPaymentRate: 0.3, segment: 'high', developer: 'Keppel Land, Tiến Phước, Trần Thái', contractor: 'Hòa Bình Corp', contractorRating: 5, status: 'Đã bàn giao', keyFeatures: 'KĐT Palm City, view sông.', contractorInfo: { name: 'Hòa Bình Corp', rating: 5, pastProjects:['Empire City'], feedbackSummary: 'Uy tín cao.'}},
            { id: 25, name: 'Define (Thạnh Mỹ Lợi)', minPrice: 5800, maxPrice: 7500, downPaymentRate: 0.3, segment: 'high', developer: 'CapitaLand', contractor: 'Hòa Bình Corp (Dự kiến)', contractorRating: 5, status: 'Đang xây', keyFeatures: 'Thiết kế siêu sang, mỗi căn có thang máy riêng.', contractorInfo: { name: 'Hòa Bình Corp', rating: 5, pastProjects:['The View Riviera Point'], feedbackSummary: 'Chất lượng quốc tế.'}},
            { id: 26, name: 'Zeit River Thủ Thiêm', minPrice: 7000, maxPrice: 9000, downPaymentRate: 0.3, segment: 'high', developer: 'GS E&C (Hàn Quốc)', contractor: 'GS E&C (Tự xây)', contractorRating: 5, status: 'Đang xây GĐ1', keyFeatures: 'KĐT Thủ Thiêm, tiêu chuẩn Hàn Quốc.', contractorInfo: { name: 'GS E&C', rating: 5, pastProjects:['Xi Riverview Palace'], feedbackSummary: 'Chất lượng xây dựng cao.'}},
            { id: 27, name: 'Metropole Thủ Thiêm (The Galleria)', minPrice: 6800, maxPrice: 8500, downPaymentRate: 0.3, segment: 'high', developer: 'SonKim Land & Quốc Lộc Phát', contractor: 'Hòa Bình Corp', contractorRating: 5, status: 'Đã bàn giao', keyFeatures: 'Đối diện Nhà hát lớn Thủ Thiêm.', contractorInfo: { name: 'Hòa Bình Corp', rating: 5, pastProjects:['The Crest Residence'], feedbackSummary: 'Đẳng cấp.'}},
            { id: 28, name: 'D\'Edge Thảo Điền', minPrice: 5500, maxPrice: 7000, downPaymentRate: 0.3, segment: 'high', developer: 'CapitaLand', contractor: 'Unicons (Ví dụ)', contractorRating: 4, status: 'Đã bàn giao', keyFeatures: 'Hồ bơi vô cực trên không nối 2 tháp.', contractorInfo: { name: 'Unicons', rating: 4, pastProjects:['Nhiều dự án CapitaLand'], feedbackSummary: 'Thành viên Coteccons.'}},
            { id: 29, name: 'The River Thủ Thiêm', minPrice: 6500, maxPrice: 8000, downPaymentRate: 0.3, segment: 'high', developer: 'City Garden Thủ Thiêm (Refico & CII)', contractor: 'Cofico (Ví dụ)', contractorRating: 4, status: 'Đã bàn giao', keyFeatures: 'Mặt tiền sông Sài Gòn, thiết kế bởi DP Architects.', contractorInfo: { name: 'Cofico', rating: 4, pastProjects:['Vista Verde'], feedbackSummary: 'Kinh nghiệm lâu năm.'}},
            { id: 30, name: 'Waterina Suites (Thạnh Mỹ Lợi)', minPrice: 5000, maxPrice: 6500, downPaymentRate: 0.3, segment: 'high', developer: 'Maeda (Nhật) & Thiên Đức', contractor: 'Maeda Vietnam', contractorRating: 5, status: 'Đã bàn giao', keyFeatures: 'Thiết kế lượn sóng bởi Kengo Kuma.', contractorInfo: { name: 'Maeda Vietnam', rating: 5, pastProjects:['Dự án hạ tầng lớn'], feedbackSummary: 'Chất lượng Nhật Bản.'}},
            { 
                id: 41, name: 'Celadon City - Emerald (Tân Phú)', 
                minPrice: 3250, maxPrice: 3500, downPaymentRate: 0.3, segment: 'high', 
                developer: 'Gamuda Land', contractor: 'Gamuda Land (Tự xây)', contractorRating: 4, 
                status: 'Đã bàn giao (Ước tính)', 
                keyFeatures: 'KĐT Celadon City, công viên 16ha, nhiều tiện ích.', 
                contractorInfo: { name: 'Gamuda Land', rating: 4, pastProjects: ['Toàn KĐT Celadon City', 'Gamuda City (Hanoi)'], feedbackSummary: 'Kinh nghiệm phát triển KĐT lớn, chất lượng tốt.'}
            },
            { 
                id: 42, name: 'Celadon City - Diamond Alnata (Tân Phú)', 
                minPrice: 4500, maxPrice: 4800, downPaymentRate: 0.3, segment: 'high', 
                developer: 'Gamuda Land', contractor: 'Gamuda Land (Tự xây)', contractorRating: 4, 
                status: 'Đã bàn giao (Ước tính)', 
                keyFeatures: 'Thuộc Diamond Precinct, thiết kế hiện đại, KĐT Celadon.', 
                contractorInfo: { name: 'Gamuda Land', rating: 4, pastProjects: ['Toàn KĐT Celadon City', 'Gamuda City (Hanoi)'], feedbackSummary: 'Kinh nghiệm phát triển KĐT lớn, chất lượng tốt.'}
            },
            { 
                id: 43, name: 'Celadon City - Diamond Brilliant (Tân Phú)', 
                minPrice: 4500, maxPrice: 6500, downPaymentRate: 0.3, segment: 'high', 
                developer: 'Gamuda Land', contractor: 'Gamuda Land (Tự xây)', contractorRating: 4, 
                status: 'Đã bàn giao (Ước tính)', 
                keyFeatures: 'Phân khu biệt lập, tiện ích riêng cao cấp, KĐT Celadon.', 
                contractorInfo: { name: 'Gamuda Land', rating: 4, pastProjects: ['Toàn KĐT Celadon City', 'Gamuda City (Hanoi)'], feedbackSummary: 'Kinh nghiệm phát triển KĐT lớn, chất lượng tốt.'}
            },
            
            // Dự án luxury
            { id: 31, name: 'The Grand Manhattan (Q1)', minPrice: 8500, maxPrice: 15000, downPaymentRate: 0.3, segment: 'luxury', developer: 'Novaland', contractor: 'Hòa Bình Corp', contractorRating: 5, status: 'Đang bàn giao', keyFeatures: 'Vị trí trung tâm Q1, khách sạn Avani.', contractorInfo: { name: 'Hòa Bình Corp', rating: 5, pastProjects:['Le Meridien Saigon'], feedbackSummary: 'Uy tín hàng đầu.'}},
            { id: 32, name: 'The Crest Residence (Thủ Thiêm)', minPrice: 9000, maxPrice: 18000, downPaymentRate: 0.3, segment: 'luxury', developer: 'SonKim Land', contractor: 'Hòa Bình Corp', contractorRating: 5, status: 'Đã bàn giao', keyFeatures: 'Thuộc The Metropole, tiện ích 5 sao.', contractorInfo: { name: 'Hòa Bình Corp', rating: 5, pastProjects:['The Galleria Residence'], feedbackSummary: 'Chất lượng cao.'}},
            { id: 33, name: 'Diamond Alnata Plus (Vinhomes Grand Park - Fictional Luxury Line)', minPrice: 7000, maxPrice: 18000, downPaymentRate: 0.3, segment: 'luxury', developer: 'Vinhomes', contractor: 'Delta Group', contractorRating: 5, status: 'Sắp mở bán', keyFeatures: 'Dòng siêu sang của Vinhomes, tiện ích đặc quyền.', contractorInfo: { name: 'Delta Group', rating: 5, pastProjects:['Vinhomes Skylake'], feedbackSummary: 'Nhà thầu lớn, kinh nghiệm.'}},
            { id: 34, name: 'Grand Marina Saigon (Q1)', minPrice: 15000, maxPrice: 30000, downPaymentRate: 0.5, segment: 'luxury', developer: 'Masterise Homes (JW Marriott)', contractor: 'Newtecons & Mace', contractorRating: 5, status: 'Đang bàn giao', keyFeatures: 'Branded residences, bến du thuyền.', contractorInfo: { name: 'Newtecons & Mace', rating: 5, pastProjects:['Các dự án Masterise'], feedbackSummary: 'Tiêu chuẩn quốc tế.'}},
            { id: 35, name: 'Serenity Sky Villas (Q3)', minPrice: 10000, maxPrice: 20000, downPaymentRate: 0.3, segment: 'luxury', developer: 'SonKim Land', contractor: 'Hòa Bình Corp (Ví dụ)', contractorRating: 5, status: 'Đã bàn giao', keyFeatures: 'Biệt thự trên không, hồ bơi riêng từng căn.', contractorInfo: { name: 'Hòa Bình Corp', rating: 5, pastProjects:['Nassim Thảo Điền'], feedbackSummary: 'Đẳng cấp xây dựng.'}},
            { id: 36, name: 'The Albany (Thảo Điền)', minPrice: 9500, maxPrice: 16000, downPaymentRate: 0.3, segment: 'luxury', developer: 'SonKim Land & Hamon Developments', contractor: 'Hòa Bình Corp (Ví dụ)', contractorRating: 5, status: 'Đã bàn giao', keyFeatures: 'Chỉ 22 căn, siêu riêng tư.', contractorInfo: { name: 'Hòa Bình Corp', rating: 5, pastProjects:['Gateway Thao Dien'], feedbackSummary: 'Chất lượng cao.'}},
            { id: 37, name: 'One Central Saigon (The Ritz-Carlton Residences)', minPrice: 20000, maxPrice: 50000, downPaymentRate: 0.5, segment: 'luxury', developer: 'Masterise Homes', contractor: 'Newtecons (Chính)', contractorRating: 5, status: 'Đang xây', keyFeatures: 'Đối diện chợ Bến Thành, thương hiệu Ritz-Carlton.', contractorInfo: { name: 'Newtecons', rating: 5, pastProjects:['Grand Marina'], feedbackSummary: 'Thi công dự án siêu sang.'}},
            { id: 38, name: 'The Marq (Q1)', minPrice: 12000, maxPrice: 22000, downPaymentRate: 0.3, segment: 'luxury', developer: 'Hongkong Land & An Khang', contractor: 'Coteccons', contractorRating: 5, status: 'Đã bàn giao', keyFeatures: 'Vị trí trung tâm, hồ bơi vô cực tầng thượng.', contractorInfo: { name: 'Coteccons', rating: 5, pastProjects:['D\'Edge'], feedbackSummary: 'Biểu tượng chất lượng.'}},
            { id: 39, name: 'Zenity CapitaLand (Q1)', minPrice: 11000, maxPrice: 19000, downPaymentRate: 0.3, segment: 'luxury', developer: 'CapitaLand', contractor: 'Hòa Bình (Ví dụ)', contractorRating: 5, status: 'Đã bàn giao (hoàn thiện từ D1 Mension)', keyFeatures: 'Số lượng giới hạn, dịch vụ concierge.', contractorInfo: { name: 'Hòa Bình', rating: 5, pastProjects:['Define'], feedbackSummary: 'Kinh nghiệm dự án sang trọng.'}},
            { id: 40, name: 'Cover Residences (Empire City)', minPrice: 18000, maxPrice: 40000, downPaymentRate: 0.3, segment: 'luxury', developer: 'Keppel Land, Tiến Phước, Gaw Capital', contractor: 'Hòa Bình (Ví dụ)', contractorRating: 5, status: 'Đã bàn giao', keyFeatures: 'View sông trực diện, tiện ích riêng biệt.', contractorInfo: { name: 'Hòa Bình', rating: 5, pastProjects:['Linden Residences'], feedbackSummary: 'Chất lượng KĐT Empire City.'}},
            { 
                id: 44, name: 'Celadon City - Diamond Centery (Tân Phú)', 
                minPrice: 5400, maxPrice: 9800, downPaymentRate: 0.3, segment: 'luxury',
                developer: 'Gamuda Land', contractor: 'Gamuda Land (Tự xây)', contractorRating: 4, 
                status: 'Đã bàn giao (Ước tính)', 
                keyFeatures: 'Căn hộ diện tích lớn, thiết kế sang trọng, KĐT Celadon.', 
                contractorInfo: { name: 'Gamuda Land', rating: 4, pastProjects: ['Toàn KĐT Celadon City', 'Gamuda City (Hanoi)'], feedbackSummary: 'Kinh nghiệm phát triển KĐT lớn, chất lượng tốt cho dòng cao cấp.'}
            }
        ];

        let salaryGrowthChartInstance = null;
        let savingsGoalChartInstance = null;
        let selectedProjectForChart = null;

        // Hàm tính tỷ lệ tăng giá theo phân khúc và thời gian
        function calculateSegmentGrowthRate(segment, baseRate, year) {
            // Tỷ lệ tăng trưởng cơ bản theo phân khúc
            const segmentMultipliers = {
                'affordable': 1.5,   // Tăng nhanh nhất do khan hiếm đất
                'mid': 1.2,          // Tăng ổn định
                'high': 0.85,        // Tăng chậm hơn
                'luxury': 0.6        // Tăng chậm nhất
            };
            
            // Yếu tố giảm dần theo thời gian (diminishing returns)
            const timeDecayFactor = Math.max(0.3, 1 - (year * 0.05)); // Giảm 5% mỗi năm, tối thiểu 30%
            
            // Tính tỷ lệ cuối cùng
            const finalRate = baseRate * segmentMultipliers[segment] * timeDecayFactor;
            
            return Math.max(0.01, finalRate / 100); // Tối thiểu 1%/năm
        }

        // Hàm tính giá tương lai với logic thực tế
        function calculateFuturePrice(currentPrice, segment, basePriceIncrease, years) {
            let futurePrice = currentPrice;
            
            for (let year = 1; year <= years; year++) {
                const yearlyRate = calculateSegmentGrowthRate(segment, basePriceIncrease, year);
                futurePrice *= (1 + yearlyRate);
            }
            
            return futurePrice;
        }

        // Cập nhật hiển thị tỷ lệ tăng trưởng theo phân khúc
        function updateSegmentGrowthDisplay(basePriceIncrease) {
            const year1Rates = {
                affordable: calculateSegmentGrowthRate('affordable', basePriceIncrease, 1) * 100,
                mid: calculateSegmentGrowthRate('mid', basePriceIncrease, 1) * 100,
                high: calculateSegmentGrowthRate('high', basePriceIncrease, 1) * 100,
                luxury: calculateSegmentGrowthRate('luxury', basePriceIncrease, 1) * 100
            };

            document.getElementById('affordable-growth').textContent = year1Rates.affordable.toFixed(1);
            document.getElementById('mid-growth').textContent = year1Rates.mid.toFixed(1);
            document.getElementById('high-growth').textContent = year1Rates.high.toFixed(1);
            document.getElementById('luxury-growth').textContent = year1Rates.luxury.toFixed(1);
        }

        function formatNumber(num, isCurrency = false) {
            if (isNaN(num) || num === null) return "...";
            const formattedNum = parseFloat(num).toLocaleString('vi-VN', { minimumFractionDigits: 0, maximumFractionDigits: (num % 1 !== 0 && num < 10 && num > -10 && !isCurrency) ? 1 : (isCurrency && num < 10 && num % 1 !== 0 ? 1:0) });
            return isCurrency ? `${formattedNum} triệu VNĐ` : formattedNum;
        }

        function displaySelectedProjectInfo(project) {
            const infoCard = document.getElementById('selectedProjectInfoCard');
            if (project && project.contractorInfo) {
                document.getElementById('selectedProjectName').textContent = project.name;
                document.getElementById('selectedProjectDeveloper').textContent = project.developer || 'N/A';
                document.getElementById('selectedProjectStatus').textContent = project.status || 'N/A';
                document.getElementById('selectedProjectFeatures').innerHTML = project.keyFeatures ? project.keyFeatures.replace(/\n/g, '<br>') : 'N/A';
                
                const contractor = project.contractorInfo;
                document.getElementById('selectedProjectContractorName').textContent = contractor.name || 'N/A';
                
                const ratingContainer = document.getElementById('selectedProjectContractorRating');
                ratingContainer.innerHTML = '';
                const rating = contractor.rating || 0;
                for (let i = 1; i <= 5; i++) {
                    const star = document.createElement('i');
                    star.classList.add(i <= rating ? 'fas' : 'far', 'fa-star');
                    ratingContainer.appendChild(star);
                }

                const pastProjectsList = document.getElementById('selectedProjectContractorPast');
                pastProjectsList.innerHTML = '';
                if (contractor.pastProjects && contractor.pastProjects.length > 0) {
                    const ul = document.createElement('ul');
                    contractor.pastProjects.forEach(pName => {
                        const li = document.createElement('li');
                        li.textContent = pName;
                        ul.appendChild(li);
                    });
                    pastProjectsList.appendChild(ul);
                } else {
                    pastProjectsList.innerHTML = '<div>Chưa có thông tin.</div>';
                }
                document.getElementById('selectedProjectContractorFeedback').textContent = contractor.feedbackSummary || 'Chưa có nhận xét.';
                infoCard.style.display = 'block';
            } else {
                infoCard.style.display = 'none';
            }
        }
        
        function renderSalaryChart(yearsArray, salaryData, expensesData, monthlyNetCashSavingsData) { 
            const ctx = document.getElementById('salaryGrowthChart').getContext('2d');
            if (salaryGrowthChartInstance) {
                salaryGrowthChartInstance.destroy();
            }
            salaryGrowthChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: yearsArray,
                    datasets: [
                        {
                            label: 'Lương tháng (Triệu VNĐ)',
                            data: salaryData,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.2)',
                            fill: true,
                            tension: 0.1
                        },
                        { 
                            label: 'Chi tiêu tháng (Triệu VNĐ)',
                            data: expensesData,
                            borderColor: '#fdcb6e', 
                            backgroundColor: 'rgba(253, 203, 110, 0.2)',
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Tiết kiệm ròng tiền mặt tháng (sau DCA)',
                            data: monthlyNetCashSavingsData,
                            borderColor: '#48dbfb',
                            backgroundColor: 'rgba(72, 219, 251, 0.2)',
                            fill: true,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: value => formatNumber(value) } } },
                    plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: context => `${context.dataset.label}: ${formatNumber(context.raw, true)}` } } }
                }
            });
        }

        function renderSavingsGoalChart(yearsArray, cumulativeSavingsData, selectedProjFuturePrice, selectedProjDownPayment, basePriceIncrease) {
            const ctx = document.getElementById('savingsGoalChart').getContext('2d');
            if (savingsGoalChartInstance) {
                savingsGoalChartInstance.destroy();
            }

            const datasets = []; 

            datasets.push({
                label: 'Tổng Tài Sản Tích Lũy (Triệu VNĐ)',
                data: cumulativeSavingsData,
                borderColor: '#00b894',
                backgroundColor: 'rgba(0, 184, 148, 0.2)',
                fill: true,
                tension: 0.1,
                order: 2 
            });

            const annotations = {};
            if (selectedProjectForChart) {
                if (typeof selectedProjFuturePrice === 'number' && typeof selectedProjDownPayment === 'number') {
                    annotations.line1 = {
                        type: 'line',
                        yMin: selectedProjFuturePrice,
                        yMax: selectedProjFuturePrice,
                        borderColor: 'rgb(255, 99, 132)',
                        borderWidth: 2,
                        borderDash: [6, 6],
                        label: {
                            content: `Giá ${selectedProjectForChart.name.substring(0,15)}... (${formatNumber(selectedProjFuturePrice, true)})`,
                            display: true, 
                            position: 'end',
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            font: { weight: 'bold', size: 9 },
                            padding: { top: 3, bottom:3, left:5, right:5},
                            yAdjust: -5
                        }
                    };
                    annotations.line2 = {
                        type: 'line',
                        yMin: selectedProjDownPayment,
                        yMax: selectedProjDownPayment,
                        borderColor: 'rgb(75, 192, 192)',
                        borderWidth: 2,
                        borderDash: [6, 6],
                        label: {
                            content: `Trả trước ${selectedProjectForChart.name.substring(0,10)}... (${formatNumber(selectedProjDownPayment, true)})`,
                            display: true, 
                            position: 'start',
                            backgroundColor: 'rgba(75, 192, 192, 0.8)',
                            font: { weight: 'bold', size: 9 },
                            padding: { top: 3, bottom:3, left:5, right:5},
                            yAdjust: 5
                        }
                    };
                }

                const projectMinPriceLineData = [];
                const projectMaxPriceLineData = [];

                yearsArray.forEach(yearLabel => {
                    let yearForCalc = 0;
                    if (yearLabel === 'Hiện tại') {
                        yearForCalc = 0;
                    } else if (yearLabel.startsWith('Năm ')) {
                        const yearStr = yearLabel.replace('Năm ', '');
                        yearForCalc = parseFloat(yearStr);
                        if (isNaN(yearForCalc)) yearForCalc = 0; 
                    }

                    const currentProjectMinPrice = calculateFuturePrice(selectedProjectForChart.minPrice, selectedProjectForChart.segment, basePriceIncrease, yearForCalc);
                    projectMinPriceLineData.push(currentProjectMinPrice);

                    const currentProjectMaxPrice = calculateFuturePrice(selectedProjectForChart.maxPrice, selectedProjectForChart.segment, basePriceIncrease, yearForCalc);
                    projectMaxPriceLineData.push(currentProjectMaxPrice);
                });

                datasets.push({
                    label: `Giá Min ${selectedProjectForChart.name.substring(0,10)}...`,
                    data: projectMinPriceLineData,
                    borderColor: 'rgba(255, 159, 64, 0.7)', 
                    borderDash: [3, 3],
                    fill: false, 
                    tension: 0.1,
                    pointRadius: 0,
                    order: 0 
                });

                datasets.push({
                    label: `Giá Max ${selectedProjectForChart.name.substring(0,10)}... (Vùng giá)`,
                    data: projectMaxPriceLineData,
                    borderColor: 'rgba(255, 159, 64, 0.7)', 
                    backgroundColor: 'rgba(255, 159, 64, 0.2)', 
                    borderDash: [3, 3],
                    fill: '-1', 
                    tension: 0.1,
                    pointRadius: 0,
                    order: 1 
                });
            }

            savingsGoalChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: yearsArray,
                    datasets: datasets
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: value => formatNumber(value) } } },
                    plugins: { 
                        legend: { position: 'top' }, 
                        tooltip: { 
                            callbacks: { 
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    let value = context.raw;
                                    let finalLabel = "";

                                    if (selectedProjectForChart && label.includes('Giá Max') && label.includes('(Vùng giá)')) {
                                        const minDataset = savingsGoalChartInstance.data.datasets.find(ds => ds.label.startsWith('Giá Min') && ds.label.includes(selectedProjectForChart.name.substring(0,10)));
                                        if (minDataset && context.dataIndex < minDataset.data.length) {
                                            const minValue = minDataset.data[context.dataIndex];
                                            finalLabel = `${selectedProjectForChart.name.substring(0,10)}...: ${formatNumber(minValue)} - ${formatNumber(value, true)}`;
                                        } else {
                                            finalLabel = `${label.replace(' (Vùng giá)','').replace('Giá Max ','')}: ${formatNumber(value, true)}`;
                                        }
                                    } else if (selectedProjectForChart && label.startsWith('Giá Min')) {
                                        const maxDatasetWithFill = savingsGoalChartInstance.data.datasets.find(ds => ds.label.startsWith('Giá Max') && ds.label.includes('(Vùng giá)'));
                                        if (maxDatasetWithFill) return null; 
                                        else finalLabel = `${label.replace('Giá Min ','')}: ${formatNumber(value, true)}`;
                                    }
                                    else {
                                        finalLabel = `${label}: ${formatNumber(value, true)}`;
                                    }
                                    return finalLabel;
                                }
                            }
                        },
                        annotation: { annotations: annotations }
                    }
                }
            });
        }

        function updateCalculations() {
            const salary = parseFloat(document.getElementById('salary').value) || 0;
            const expenses = parseFloat(document.getElementById('expenses').value) || 0;
            const bonus = parseFloat(document.getElementById('bonus').value) || 0;
            const currentCashSavingsInput = parseFloat(document.getElementById('current-savings').value) || 0;
            const initialInvestmentValue = parseFloat(document.getElementById('initial-investment').value) || 0;
            const dcaMonthlyAmount = parseFloat(document.getElementById('dca-amount').value) || 0;

            const targetYears = parseFloat(document.getElementById('target-years').value) || 0;
            const basePriceIncrease = 7; // Cố định 7%/năm phản ánh thị trường TP.HCM
            const salaryGrowthRate = (parseFloat(document.getElementById('salary-growth').value) || 0) / 100;
            const expensesGrowthRate = (parseFloat(document.getElementById('expenses-growth').value) || 0) / 100;
            const investmentGrowthRate = (parseFloat(document.getElementById('investment-growth').value) || 0) / 100;

            // Cập nhật hiển thị tỷ lệ tăng trưởng theo phân khúc
            updateSegmentGrowthDisplay(basePriceIncrease);

            let targetYearsDisplay = targetYears;
            if (targetYears === 0.5) targetYearsDisplay = "6 tháng";
            else if (targetYears === 1.5) targetYearsDisplay = "1.5 năm";
            else if (targetYears % 1 === 0) targetYearsDisplay = `${targetYears} năm`;
            else targetYearsDisplay = `${targetYears.toFixed(1)} năm`;

            document.getElementById('years-display').textContent = targetYearsDisplay;
            document.getElementById('years-display-2').textContent = targetYearsDisplay;
            document.getElementById('years-display-3').textContent = targetYearsDisplay;

            const initialMonthlyGrossSavings = salary - expenses;
            const initialMonthlyNetCashSavings = initialMonthlyGrossSavings - dcaMonthlyAmount;
            
            document.getElementById('monthly-net-savings').textContent = formatNumber(initialMonthlyNetCashSavings, true);

            const savingsRateBeforeDCA = salary > 0 ? (initialMonthlyGrossSavings / salary * 100).toFixed(1) : 0;
            document.getElementById('savings-rate').textContent = `${savingsRateBeforeDCA}%`;
            
            const salaryChartYears = ['Hiện tại'];
            const salaryChartData = [salary];
            const expensesChartData = [expenses]; 
            const monthlyNetCashSavingsChartData = [initialMonthlyNetCashSavings];
            
            let cumulativeCashSavings = currentCashSavingsInput;
            let currentInvestmentPortfolioValue = initialInvestmentValue;
            let totalCumulativeAssets = cumulativeCashSavings + currentInvestmentPortfolioValue;

            const savingsGoalChartYears = ['Hiện tại'];
            const savingsGoalData = [totalCumulativeAssets];
            
            const timelineDisplayData = [{
                yearLabel: 'Hiện tại',
                amount: totalCumulativeAssets,
                cash: cumulativeCashSavings,
                investments: currentInvestmentPortfolioValue,
                salary: salary,
                expenses: expenses,
                savingBeforeDCA: initialMonthlyGrossSavings,
                netCashSaving: initialMonthlyNetCashSavings
            }];

            if (targetYears > 0) {
                let monthlyEffectiveTarget = Math.round(targetYears * 12);
                for (let month = 1; month <= monthlyEffectiveTarget; month++) {
                    let yearIndexForGrowth = Math.floor((month - 1) / 12);
                    let currentMonthlySalary = salary * Math.pow(1 + salaryGrowthRate, yearIndexForGrowth);
                    let currentMonthlyExpenses = expenses * Math.pow(1 + expensesGrowthRate, yearIndexForGrowth);
                    let currentMonthlyGrossSavings = currentMonthlySalary - currentMonthlyExpenses;
                    let currentMonthlyNetCashSavings = currentMonthlyGrossSavings - dcaMonthlyAmount;

                    cumulativeCashSavings += currentMonthlyNetCashSavings;
                    
                    let currentAnnualBonus = bonus * Math.pow(1 + salaryGrowthRate, yearIndexForGrowth);
                    cumulativeCashSavings += (currentAnnualBonus / 12);

                    currentInvestmentPortfolioValue += dcaMonthlyAmount;
                    currentInvestmentPortfolioValue *= (1 + investmentGrowthRate / 12);

                    totalCumulativeAssets = cumulativeCashSavings + currentInvestmentPortfolioValue;

                    if (month % 12 === 0 || month === monthlyEffectiveTarget) {
                        let yearLabel;
                        if (month === monthlyEffectiveTarget && targetYears % 1 !== 0) {
                             yearLabel = targetYears % 1 === 0.5 ? `Năm ${Math.floor(targetYears)}.5` : `Năm ${targetYears.toFixed(1)}`;
                        } else {
                            yearLabel = `Năm ${month/12}`;
                        }
                        
                        if (!savingsGoalChartYears.includes(yearLabel) || month === monthlyEffectiveTarget) {
                            if (month === monthlyEffectiveTarget && savingsGoalChartYears[savingsGoalChartYears.length-1].startsWith("Năm " + Math.floor(targetYears)) && targetYears % 1 !== 0) {
                                savingsGoalChartYears[savingsGoalChartYears.length -1] = yearLabel;
                                savingsGoalData[savingsGoalData.length -1] = totalCumulativeAssets;
                                salaryChartYears[salaryChartYears.length -1] = yearLabel;
                                salaryChartData[salaryChartData.length -1] = currentMonthlySalary;
                                expensesChartData[expensesChartData.length -1] = currentMonthlyExpenses; 
                                monthlyNetCashSavingsChartData[monthlyNetCashSavingsChartData.length -1] = currentMonthlyNetCashSavings;
                            } else if (!savingsGoalChartYears.includes(yearLabel)){
                                savingsGoalChartYears.push(yearLabel);
                                savingsGoalData.push(totalCumulativeAssets);
                                salaryChartYears.push(yearLabel);
                                salaryChartData.push(currentMonthlySalary);
                                expensesChartData.push(currentMonthlyExpenses); 
                                monthlyNetCashSavingsChartData.push(currentMonthlyNetCashSavings);
                            }
                        }
                         if(!timelineDisplayData.find(item => item.yearLabel === yearLabel) || month === monthlyEffectiveTarget) {
                            timelineDisplayData.push({
                                yearLabel: yearLabel,
                                amount: totalCumulativeAssets,
                                cash: cumulativeCashSavings,
                                investments: currentInvestmentPortfolioValue,
                                salary: currentMonthlySalary,
                                expenses: currentMonthlyExpenses, 
                                savingBeforeDCA: currentMonthlyGrossSavings,
                                netCashSaving: currentMonthlyNetCashSavings
                            });
                        }
                    }
                }
            }
            
            if (targetYears > 0 && targetYears % 1 !== 0) {
                 const finalYearLabel = targetYears % 1 === 0.5 ? `Năm ${Math.floor(targetYears)}.5` : `Năm ${targetYears.toFixed(1)}`;
                if (savingsGoalChartYears[savingsGoalChartYears.length -1] !== finalYearLabel) { 
                    savingsGoalChartYears.push(finalYearLabel);
                    savingsGoalData.push(totalCumulativeAssets);
                    
                    let lastYearIndexForGrowth = Math.floor((Math.round(targetYears * 12) -1) / 12);
                    let lastCurrentMonthlySalary = salary * Math.pow(1 + salaryGrowthRate, lastYearIndexForGrowth);
                    let lastCurrentMonthlyExpenses = expenses * Math.pow(1 + expensesGrowthRate, lastYearIndexForGrowth); 
                    let lastCurrentMonthlyGrossSavings = lastCurrentMonthlySalary - lastCurrentMonthlyExpenses;
                    let lastCurrentMonthlyNetCashSavings = lastCurrentMonthlyGrossSavings - dcaMonthlyAmount;

                    salaryChartYears.push(finalYearLabel);
                    salaryChartData.push(lastCurrentMonthlySalary);
                    expensesChartData.push(lastCurrentMonthlyExpenses); 
                    monthlyNetCashSavingsChartData.push(lastCurrentMonthlyNetCashSavings);
                }
            }

            document.getElementById('total-savings').textContent = formatNumber(totalCumulativeAssets, true);
            document.getElementById('final-investment-value').textContent = formatNumber(currentInvestmentPortfolioValue, true);

            const houseBudget = totalCumulativeAssets > 0 ? totalCumulativeAssets / 0.3 : 0; 
            const loanAmount = Math.max(0, houseBudget - totalCumulativeAssets);
            document.getElementById('loan-amount').textContent = formatNumber(loanAmount, true);
            document.getElementById('house-budget').textContent = formatNumber(houseBudget, true);

            // Sử dụng logic tăng giá thực tế cho căn hộ 1.5 tỷ
            const hypotheticalHousePriceNow = 1500;
            const futureHypotheticalPrice = calculateFuturePrice(hypotheticalHousePriceNow, 'mid', basePriceIncrease, targetYears);
            document.getElementById('future-house-price').textContent = formatNumber(futureHypotheticalPrice, true);

            updateTimeline(targetYears, timelineDisplayData);
            updateHouseAffordability(totalCumulativeAssets, houseBudget, targetYears, basePriceIncrease);
            
            let selectedProjFuturePriceVal = null;
            let selectedProjDownPaymentVal = null;
            if (selectedProjectForChart) {
                const avgPriceNow = (selectedProjectForChart.minPrice + selectedProjectForChart.maxPrice) / 2;
                selectedProjFuturePriceVal = calculateFuturePrice(avgPriceNow, selectedProjectForChart.segment, basePriceIncrease, targetYears);
                selectedProjDownPaymentVal = selectedProjFuturePriceVal * selectedProjectForChart.downPaymentRate;
            }

            renderSalaryChart(salaryChartYears, salaryChartData, expensesChartData, monthlyNetCashSavingsChartData); 
            renderSavingsGoalChart(savingsGoalChartYears, savingsGoalData, selectedProjFuturePriceVal, selectedProjDownPaymentVal, basePriceIncrease);
            
            let tipTargetYears = targetYears;
            if (targetYears === 0.5) tipTargetYears = "6 tháng"; else if (targetYears === 1.5) tipTargetYears = "1.5 năm"; else tipTargetYears = `${targetYears % 1 === 0 ? targetYears : targetYears.toFixed(1)} năm`;
            
            const dcaImpactText = dcaMonthlyAmount > 0 ? ` Việc đầu tư DCA ${formatNumber(dcaMonthlyAmount, true)}/tháng với tăng trưởng ${formatNumber(investmentGrowthRate*100, false)}%/năm giúp bạn có thêm khoảng ${formatNumber(currentInvestmentPortfolioValue - (initialInvestmentValue + dcaMonthlyAmount * targetYears * 12) , true)} so với chỉ gửi tiết kiệm.` : "";

            document.getElementById('quick-tip').innerHTML = `💡 <strong>Mẹo nhanh:</strong> Với mục tiêu ${tipTargetYears}, bạn có thể tích lũy được khoảng ${formatNumber(totalCumulativeAssets, true)} (bao gồm cả đầu tư).${dcaImpactText} Để tăng tốc, hãy xem xét tăng thu nhập, giảm chi tiêu, hoặc tìm cách tối ưu tỷ suất lợi nhuận đầu tư. Mỗi 1% tăng trưởng lương hàng năm sẽ giúp bạn có thêm khoảng ${formatNumber( (salary * 0.01 * 12 * targetYears) + (salary*0.01 * 12 * targetYears * (targetYears-1)/2 * salaryGrowthRate) , true)} sau ${tipTargetYears}.`;
        }

        function updateTimeline(targetYears, timelinePointsArray) {
            const timelineGrid = document.getElementById('timeline-grid');
            timelineGrid.innerHTML = '';
            
            if (timelinePointsArray.length > 0) {
                const uniqueTimelinePoints = [];
                const seenLabels = new Set();
                
                let sortedPoints = [...timelinePointsArray];
                const currentIndex = sortedPoints.findIndex(p => p.yearLabel === "Hiện tại");
                if (currentIndex > 0) {
                    const currentPoint = sortedPoints.splice(currentIndex, 1)[0];
                    sortedPoints.unshift(currentPoint);
                }

                sortedPoints.forEach(data => {
                    if (!seenLabels.has(data.yearLabel)) {
                        uniqueTimelinePoints.push(data);
                        seenLabels.add(data.yearLabel);
                    } else if (data.yearLabel.includes('.')) {
                        const existingIndex = uniqueTimelinePoints.findIndex(p => p.yearLabel === data.yearLabel);
                        if(existingIndex !== -1) uniqueTimelinePoints[existingIndex] = data;
                        else uniqueTimelinePoints.push(data);
                    }
                });

                uniqueTimelinePoints.forEach(data => {
                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('timeline-item');
                    itemDiv.innerHTML = `
                        <div class="timeline-year">${data.yearLabel}</div>
                        <div class="timeline-amount" title="Tiền mặt: ${formatNumber(data.cash, true)}\nĐầu tư: ${formatNumber(data.investments, true)}">${formatNumber(data.amount, true)}</div>
                        <div class="timeline-desc">
                            Lương: ${formatNumber(data.salary, true)}<br>
                            Chi tiêu: ${formatNumber(data.expenses, true)}<br>
                            TK (trước DCA): ${formatNumber(data.savingBeforeDCA, true)}<br>
                            TK ròng (sau DCA): ${formatNumber(data.netCashSaving, true)}
                        </div>
                    `;
                    timelineGrid.appendChild(itemDiv);
                });
            }
        }

        function updateHouseAffordability(currentTotalAssets, totalBudget, targetYears, basePriceIncrease) {
            let affordableCount = 0;
            let recommendationText = "Với tình hình hiện tại, bạn nên tập trung tích lũy thêm.";
            let firstAffordableProjectDownPayment = Infinity;
            let progressPercent = 0;
            let progressText = "Chưa có dự án nào trong tầm tay.";

            PROJECTS_DATA.forEach(project => {
                const card = document.getElementById(`houseCard${project.id}`);
                const statusBadge = document.getElementById(`status${project.id}`);
                if (!card || !statusBadge) {
                    console.warn(`Card or status badge not found for project ID ${project.id}`);
                    return; 
                }

                // Sử dụng logic tăng giá thực tế
                const avgPriceNow = (project.minPrice + project.maxPrice) / 2;
                const futurePrice = calculateFuturePrice(avgPriceNow, project.segment, basePriceIncrease, targetYears);
                const downPaymentNeeded = futurePrice * project.downPaymentRate;

                // Cập nhật hiển thị giá dự kiến tương lai
                const priceProjectionDiv = card.querySelector('.price-projection') || document.createElement('div');
                if (!card.querySelector('.price-projection')) {
                    priceProjectionDiv.className = 'price-projection';
                    card.appendChild(priceProjectionDiv);
                }
                
                const currentAvgPrice = (project.minPrice + project.maxPrice) / 2;
                const increasePercent = ((futurePrice - currentAvgPrice) / currentAvgPrice * 100).toFixed(1);
                priceProjectionDiv.innerHTML = `Dự kiến sau ${targetYears === 0.5 ? '6 tháng' : targetYears === 1.5 ? '1.5 năm' : targetYears + ' năm'}: ${formatNumber(futurePrice, true)} (+${increasePercent}%)`;

                let statusClass = '';
                let statusText = '';

                if (currentTotalAssets >= downPaymentNeeded && totalBudget >= futurePrice) {
                    statusText = "✅ Khả Thi";
                    statusClass = 'status-green';
                    affordableCount++;
                     if (downPaymentNeeded < firstAffordableProjectDownPayment && downPaymentNeeded > 0) {
                        firstAffordableProjectDownPayment = downPaymentNeeded;
                    } else if (downPaymentNeeded === 0 && firstAffordableProjectDownPayment === Infinity) {
                        firstAffordableProjectDownPayment = 0;
                    }
                } else if (currentTotalAssets >= downPaymentNeeded * 0.7 && totalBudget >= futurePrice * 0.8) {
                    statusText = "🤏 Cần Cố Gắng";
                    statusClass = 'status-orange';
                } else {
                    statusText = "⛔ Chưa Phù Hợp";
                    statusClass = 'status-red';
                }
                
                statusBadge.style.opacity = 1;
                if (project.segment === 'luxury') { 
                    if (currentTotalAssets >= downPaymentNeeded && totalBudget >= futurePrice) {
                         statusText = "💎 Luxury Khả Thi!";
                         statusClass = 'status-luxury-custom';
                    } else if (currentTotalAssets >= downPaymentNeeded * 0.5 && totalBudget >= futurePrice * 0.6) {
                        statusText = "💎 Luxury (Cần Thêm)";
                        statusClass = 'status-luxury-custom';
                        statusBadge.style.opacity = 0.7;
                    } else {
                        statusText = "💎 Luxury (Xa)";
                        statusClass = 'status-luxury-custom';
                        statusBadge.style.opacity = 0.4;
                    }
                }

                statusBadge.textContent = statusText;
                statusBadge.className = `status-badge ${statusClass}`;
                if (project.segment === 'luxury' && !statusBadge.classList.contains('status-luxury-custom')) {
                    statusBadge.classList.add('status-luxury-custom');
                }

                card.classList.remove('affordable', 'stretch', 'future', 'house-luxury');
                if (project.segment === 'luxury') {
                     card.classList.add('house-luxury');
                 }

                if (currentTotalAssets >= downPaymentNeeded && totalBudget >= futurePrice ) { 
                    card.classList.add('affordable');
                } else if (currentTotalAssets >= downPaymentNeeded * 0.7 && totalBudget >= futurePrice * 0.8) {
                    card.classList.add('stretch');
                } else {
                    card.classList.add('future');
                }
            });

            document.getElementById('affordable-count').textContent = `${affordableCount} / ${PROJECTS_DATA.length}`;

            if (affordableCount > 0) {
                recommendationText = `Tuyệt vời! Bạn có thể cân nhắc ${affordableCount} dự án. Hãy xem xét các dự án có đánh dấu "Khả Thi".`;
                 if (firstAffordableProjectDownPayment !== Infinity && firstAffordableProjectDownPayment > 0) {
                    progressPercent = Math.min((currentTotalAssets / firstAffordableProjectDownPayment) * 100, 100);
                    progressText = `Đạt ${progressPercent.toFixed(0)}% mục tiêu trả trước cho dự án khả thi đầu tiên.`;
                } else if (firstAffordableProjectDownPayment === 0 && currentTotalAssets >=0){
                    progressPercent = 100;
                    progressText = `Đã đủ tiền trả trước cho dự án khả thi đầu tiên!`;
                } else if (firstAffordableProjectDownPayment === Infinity && affordableCount > 0){
                     progressPercent = 100;
                     progressText = `Đã đủ tiền trả trước cho các dự án khả thi!`;
                }
            } else if (PROJECTS_DATA.some(p => {
                const futurePrice = calculateFuturePrice(((p.minPrice + p.maxPrice) / 2), p.segment, basePriceIncrease, targetYears);
                return currentTotalAssets >= (futurePrice * p.downPaymentRate * 0.7) && totalBudget >= futurePrice * 0.8;
            })) {
                recommendationText = "Bạn đang tiến gần mục tiêu! Một vài dự án " + '"Cần Cố Gắng"' + " có thể sớm nằm trong tầm tay.";
                let closestStretchDownPayment = Infinity;
                PROJECTS_DATA.filter(p_stretch => {
                     const futurePrice_s = calculateFuturePrice(((p_stretch.minPrice + p_stretch.maxPrice) / 2), p_stretch.segment, basePriceIncrease, targetYears);
                     return currentTotalAssets >= (futurePrice_s * p_stretch.downPaymentRate * 0.7) && totalBudget >= futurePrice_s * 0.8 && 
                            !(currentTotalAssets >= futurePrice_s * p_stretch.downPaymentRate && totalBudget >= futurePrice_s);
                }).forEach(p_stretch_detail => {
                    const dp_s = calculateFuturePrice(((p_stretch_detail.minPrice + p_stretch_detail.maxPrice) / 2), p_stretch_detail.segment, basePriceIncrease, targetYears) * p_stretch_detail.downPaymentRate;
                    if (dp_s < closestStretchDownPayment && dp_s > 0) closestStretchDownPayment = dp_s;
                    else if (dp_s === 0 && closestStretchDownPayment === Infinity) closestStretchDownPayment = 0;
                });

                if(closestStretchDownPayment !== Infinity && closestStretchDownPayment > 0) {
                    progressPercent = Math.min((currentTotalAssets / closestStretchDownPayment) * 100, 100);
                    progressText = `Đạt ${progressPercent.toFixed(0)}% mục tiêu trả trước cho dự án "Cần cố gắng" gần nhất.`;
                } else if (closestStretchDownPayment === 0){
                     progressPercent = 100;
                     progressText = `Đã đủ tiền trả trước cho dự án "Cần cố gắng" gần nhất!`;
                }
            }
            document.getElementById('recommendation').innerHTML = recommendationText;
            document.getElementById('progress-bar').style.width = `${progressPercent}%`;
            document.getElementById('progress-text').textContent = progressText;
        }
        
        function generateHouseCardsDynamically() {
            const houseOptionsContainer = document.querySelector('.house-options');
            if (!houseOptionsContainer) {
                console.error("CRITICAL: houseOptionsContainer not found!");
                return;
            }

            const existingCards = houseOptionsContainer.querySelectorAll('.house-card');
            existingCards.forEach(card => card.remove());

            const headers = {
                affordable: houseOptionsContainer.querySelector('.affordable-category'),
                mid: houseOptionsContainer.querySelector('.mid-category'),
                high: houseOptionsContainer.querySelector('.high-category'),
                luxury: houseOptionsContainer.querySelector('.luxury-category')
            };

            const cardsBySegment = { affordable: [], mid: [], high: [], luxury: [] };

            PROJECTS_DATA.forEach(project => {
                const card = document.createElement('div');
                card.classList.add('house-card');
                card.classList.add(`house-${project.segment}`);
                
                card.id = `houseCard${project.id}`;
                card.dataset.projectId = project.id;

                let badgeClass = 'status-badge ';
                if (project.segment === 'luxury') badgeClass += 'status-luxury-custom';
                else badgeClass += 'status-red';

                card.innerHTML = `
                    <div class="house-title">🏢 ${project.name}</div>
                    <div class="house-price">${formatNumber(project.minPrice, false)} - ${formatNumber(project.maxPrice, false)} triệu VNĐ</div>
                    <div class="house-details">
                        ${project.keyFeatures ? project.keyFeatures.split('\n').map(line => line.trim() + '<br>').join('') : 'Thông tin đang cập nhật...<br>'}
                        • Vốn cần trả trước: ${project.downPaymentRate * 100}%
                    </div>
                    <div class="${badgeClass}" id="status${project.id}">Đang tính...</div>
                `;
                
                card.addEventListener('click', function() {
                    const projId = parseInt(this.dataset.projectId);
                    const proj = PROJECTS_DATA.find(p => p.id === projId);
                    document.querySelectorAll('.house-card').forEach(c => c.classList.remove('selected-for-chart'));
                    if (selectedProjectForChart && selectedProjectForChart.id === projId) {
                        selectedProjectForChart = null;
                        displaySelectedProjectInfo(null);
                    } else {
                        selectedProjectForChart = proj;
                        this.classList.add('selected-for-chart');
                        displaySelectedProjectInfo(proj);
                    }
                    updateCalculations();
                });

                if (project.segment && cardsBySegment[project.segment]) {
                    cardsBySegment[project.segment].push(card);
                } else {
                    console.warn(`Unknown segment "${project.segment}" for project "${project.name}" or cardsBySegment issue.`);
                }
            });
            
            Object.keys(cardsBySegment).forEach(segment => {
                const header = headers[segment];
                const cards = cardsBySegment[segment];
                
                if (header && cards.length > 0) {
                    let currentElementToInsertAfter = header;
                    cards.forEach(cardNode => {
                        currentElementToInsertAfter.insertAdjacentElement('afterend', cardNode);
                        currentElementToInsertAfter = cardNode;
                    });
                } else {
                     if(!header) console.warn(`Header for segment ${segment} not found.`);
                }
            });
        }

        function filterHouses(segment) {
            const allCards = document.querySelectorAll('.house-options .house-card'); 
            const allHeaders = document.querySelectorAll('.house-options .category-header');
            const filterButtons = document.querySelectorAll('.filter-btn');

            filterButtons.forEach(btn => btn.classList.remove('active'));
            const activeButton = document.querySelector(`.filter-btn[onclick="filterHouses('${segment}')"]`);
            if (activeButton) activeButton.classList.add('active');

            if (segment === 'all') {
                allCards.forEach(card => card.style.display = 'block');
                allHeaders.forEach(header => header.style.display = 'flex'); 
            } else {
                allCards.forEach(card => {
                    if (card.classList.contains(`house-${segment}`)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
                allHeaders.forEach(header => header.style.display = 'none');
                const activeHeader = document.querySelector(`.house-options .category-header.${segment}-category`);
                if (activeHeader) {
                    activeHeader.style.display = 'flex';
                }
            }
        }

        function toggleGuide() {
            const guideContent = document.getElementById('guideContent');
            const toggleButton = document.querySelector('.guide-toggle');
            
            if (guideContent.classList.contains('active')) {
                guideContent.classList.remove('active');
                toggleButton.innerHTML = '📚 Hướng Dẫn Sử Dụng Chi Tiết';
            } else {
                guideContent.classList.add('active');
                toggleButton.innerHTML = '❌ Ẩn Hướng Dẫn';
                // Scroll to guide section
                guideContent.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        document.querySelectorAll('.input-group input, .input-group select').forEach(input => {
            input.addEventListener('input', updateCalculations);
            if (input.tagName === 'SELECT') input.addEventListener('change', updateCalculations);
        });
        
        if (typeof ChartAnnotation !== 'undefined') {
             Chart.register(ChartAnnotation);
        } else {
            console.error("Chart.js Annotation Plugin not loaded!");
        }

        generateHouseCardsDynamically(); 
        displaySelectedProjectInfo(null); 
        updateCalculations(); 
        filterHouses('all');
    </script>
</body>
</html>