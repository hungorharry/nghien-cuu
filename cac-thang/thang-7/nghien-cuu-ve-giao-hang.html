<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Phân Tích Vận Hành Liên Kết</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS (XLSX) CDN for Excel processing -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        :root {
            --bg-main: #f4f7fe; --bg-card: #ffffff; --text-primary: #1a202c; --text-secondary: #4a5568; 
            --border-color: #e2e8f0; --primary-blue: #3b82f6; --primary-green: #10b981; 
            --primary-orange: #f97316; --primary-red: #ef4444;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-main); color: var(--text-secondary); }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; vertical-align: middle; font-size: 20px; }
        .card { background-color: var(--bg-card); border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
        h1, h2, h3 { color: var(--text-primary); font-weight: 700; }
        h1 { cursor: pointer; } 
        h2 { font-size: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; }
        .kpi-card { transition: all 0.3s ease-in-out; cursor: pointer; }
        .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.08); }
        .kpi-container.transitioning .kpi-card { opacity: 0; transform: translateY(10px); }
        .skeleton { background-color: #e2e8f0; border-radius: 4px; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 50% { opacity: .5; } }
        .timeline { position: relative; padding-left: 40px; }
        .timeline::before { content: ''; position: absolute; left: 14px; top: 5px; bottom: 5px; width: 2px; background-color: var(--border-color); }
        .timeline-item { position: relative; margin-bottom: 1.25rem; }
        .timeline-item::before { content: ''; position: absolute; left: -8px; top: 4px; width: 16px; height: 16px; border-radius: 50%; background-color: #cbd5e1; border: 3px solid var(--bg-card); transition: background-color 0.2s; }
        .timeline-item.problem-highlight::before { background-color: var(--primary-orange); }
        .timeline-item-content { padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .timeline-item-content:hover { background-color: #f7fafc; }
        .timeline-item.active .timeline-item-content { background-color: #ebf8ff; font-weight: 600; }
        .timeline-item.active::before { background-color: var(--primary-blue); }
        .search-results-dropdown { box-shadow: 0 4px 12px rgba(0,0,0,0.08); max-height: 220px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #e2e8f0 var(--bg-card); }
        #comparisonTable th[data-sort-key] { cursor: pointer; user-select: none; position: relative; padding-right: 20px; }
        #comparisonTable th[data-sort-key]::after { content: ' '; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); border: 4px solid transparent; opacity: 0.3; }
        #comparisonTable th[data-sort-order="asc"]::after { border-bottom-color: var(--text-secondary); opacity: 1; }
        #comparisonTable th[data-sort-order="desc"]::after { border-top-color: var(--text-secondary); opacity: 1; }
        #scrollToTopBtn { transition: opacity 0.3s, visibility 0.3s; opacity: 0; visibility: hidden; }
        #scrollToTopBtn.visible { opacity: 1; visibility: visible; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-screen-2xl mx-auto">
        <header id="mainHeader" class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-800" title="Quay về trang tổng quan">Dashboard Phân Tích Vận Hành Liên Kết</h1>
                <p id="subHeader" class="text-gray-500 mt-1">Nơi tổng hợp và phân tích dữ liệu hiệu suất giao hàng.</p>
            </div>
            <div id="headerActions" class="flex items-center gap-2 md:gap-4 flex-wrap">
                <div id="employeeSearchContainer" class="relative w-full md:w-56">
                    <input type="text" id="employeeSearch" placeholder="Tìm hoặc chọn nhân viên..." class="w-full appearance-none bg-white border border-gray-300 text-gray-700 py-2 px-4 pr-10 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-blue-500"/>
                    <span id="searchDropdownBtn" class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer"><span class="material-symbols-outlined text-gray-500">arrow_drop_down</span></span>
                    <div id="searchResults" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 hidden search-results-dropdown"></div>
                </div>
                <button id="compareAllBtn" class="flex items-center gap-2 bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition">
                    <span class="material-symbols-outlined">compare_arrows</span>So Sánh
                </button>
                <button id="importBtn" class="flex items-center gap-2 bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition">
                    <span class="material-symbols-outlined">upload_file</span>Nhập Excel
                </button>
                <button id="downloadHtmlBtn" class="flex items-center gap-2 bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition opacity-50 cursor-not-allowed" disabled title="Tải báo cáo HTML có thể chia sẻ và xem lại">
                    <span class="material-symbols-outlined">download</span>Tải Báo Cáo
                </button>
            </div>
        </header>

        <section id="kpi-overview" class="kpi-container grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card animate-pulse flex items-center gap-4 bg-gray-200 h-[92px]"></div>
            <div class="card animate-pulse flex items-center gap-4 bg-gray-200 h-[92px]"></div>
            <div class="card animate-pulse flex items-center gap-4 bg-gray-200 h-[92px]"></div>
            <div class="card animate-pulse flex items-center gap-4 bg-gray-200 h-[92px]"></div>
        </section>

        <div id="main-content" class="card">
            <div id="employeeDetailView" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 space-y-6">
                        <div id="employeeProfileCard" class="p-4 border rounded-lg bg-gray-50 flex items-start gap-4"></div>
                        <div id="timelineContainer" class="p-4 rounded-lg border transition-all duration-300">
                            <h3 class="font-bold text-lg mb-2">Quy trình & Các điểm nóng</h3>
                            <p class="text-sm text-gray-500 mb-4">Click vào bước để xem chi tiết và phân tích chéo.</p>
                            <div id="processTimeline" class="timeline"></div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-6">
                        <div class="h-80 md:h-96 relative"><canvas id="performanceRadarChart"></canvas></div>
                        <div id="actionableInsights"></div>
                    </div>
                 </div>
            </div>
            <div id="placeholderView" class="text-center py-20">
                <span class="material-symbols-outlined text-6xl text-gray-300">query_stats</span>
                <p class="mt-4 text-lg font-medium text-gray-500">Sẵn sàng phân tích dữ liệu giao hàng của bạn.</p>
                <p class="text-sm text-gray-400">Bắt đầu bằng cách <button id="importBtnPlaceholder" class="text-blue-500 underline font-semibold">nhập file Excel</button>.</p>
            </div>
        </div>
        
        <section id="comparisonView" class="hidden card mt-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <h2 id="comparisonTitle" class="text-xl font-bold border-none p-0 m-0 whitespace-nowrap">So sánh Hiệu suất Nhân viên</h2>
                <div class="flex items-center gap-4 w-full sm:w-auto">
                    <div class="flex-grow">
                        <label for="comparisonFilterSelect" class="sr-only">Lọc theo tiêu chí</label>
                        <select id="comparisonFilterSelect" class="w-full bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-blue-500 text-sm">
                            <option value="all">Lọc theo tiêu chí...</option>
                            <option value="hasProblems">Có vấn đề ghi nhận</option>
                            <option value="successRate">Tỷ lệ Giao hàng Thấp</option>
                            <option value="avgTime">Thời gian Giao hàng Cao</option>
                            <option value="satisfaction">Đánh giá Hài lòng Thấp</option>
                            <option value="avgSkill">Điểm Kỹ năng Thấp</option>
                        </select>
                    </div>
                    <button id="clearFilterBtn" class="hidden flex items-center gap-2 bg-blue-100 text-blue-700 font-semibold py-1.5 px-3 rounded-lg hover:bg-blue-200 transition text-sm">
                        <span class="material-symbols-outlined !text-base">filter_alt_off</span> Xóa bộ lọc
                    </button>
                </div>
            </div>
            <div id="comparisonChartContainer" class="mb-8 h-96 relative"><canvas id="comparisonChart"></canvas></div>
            <p class="text-sm text-gray-500 mb-4">Click tiêu đề cột để sắp xếp, click vào hàng để xem chi tiết.</p>
            <div class="overflow-x-auto">
                <table id="comparisonTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort-key="name">Tên Nhân Viên</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort-key="totalOrders">Tổng Đơn</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort-key="successRate">Giao T.Công</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort-key="avgTime">TG Giao TB</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort-key="satisfaction">Đánh Giá</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort-key="avgSkill">TB Kỹ năng</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </section>
    </div>
    
    <div id="excelGuideModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b pb-4 mb-6"><h3 class="text-2xl font-bold text-gray-800">Hướng Dẫn Nhập File Excel</h3><button id="closeModalBtn" class="text-gray-400 hover:text-gray-700 text-3xl leading-none">×</button></div>
            <p class="mb-4">File Excel của bạn cần có <strong>4 sheet</strong> với tên và cấu trúc chính xác như sau:</p>
            <div class="space-y-6"><div><h4 class="font-semibold text-lg text-blue-600 mb-2">Sheet 1: <code class="bg-gray-200 px-2 py-1 rounded">KPIs</code></h4><table class="w-full text-sm border"><thead class="bg-gray-100"><tr><th class="border p-2">TotalOrders</th><th class="border p-2">SuccessRate</th><th class="border p-2">AvgTime</th><th class="border p-2">Satisfaction</th></tr></thead><tbody><tr><td class="border p-2">1,280</td><td class="border p-2">96.5%</td><td class="border p-2">32 phút</td><td class="border p-2">4.7 / 5</td></tr></tbody></table></div><div><h4 class="font-semibold text-lg text-blue-600 mb-2">Sheet 2: <code class="bg-gray-200 px-2 py-1 rounded">NhanVien</code></h4><table class="w-full text-sm border"><thead class="bg-gray-100"><tr><th class="border p-2">ID</th><th class="border p-2">Name</th><th class="border p-2">Title</th><th class="border p-2">TocDo</th><th class="border p-2">ChinhXac</th><th class="border p-2">GiaoTiep</th><th class="border p-2">XuLyVanDe</th><th class="border p-2">ChuDong</th></tr></thead><tbody><tr><td class="border p-2">GD007</td><td class="border p-2">Nguyễn Minh Tuấn</td><td class="border p-2">NV Giao hàng</td><td class="border p-2">5</td><td class="border p-2">5</td><td class="border p-2">4</td><td class="border p-2">4</td><td class="border p-2">5</td></tr></tbody></table></div><div><h4 class="font-semibold text-lg text-blue-600 mb-2">Sheet 3: <code class="bg-gray-200 px-2 py-1 rounded">VanDe</code></h4><table class="w-full text-sm border"><thead class="bg-gray-100"><tr><th class="border p-2">EmployeeID</th><th class="border p-2">StepID</th><th class="border p-2">Weakness</th><th class="border p-2">Solution</th></tr></thead><tbody><tr><td class="border p-2">GD015</td><td class="border p-2">step-3</td><td class="border p-2">Chưa tối ưu lộ trình</td><td class="border p-2">Đào tạo 1-1 về bản đồ</td></tr></tbody></table></div><div><h4 class="font-semibold text-lg text-blue-600 mb-2">Sheet 4: <code class="bg-gray-200 px-2 py-1 rounded">KPI_NhanVien</code></h4><table class="w-full text-sm border"><thead class="bg-gray-100"><tr><th class="border p-2">EmployeeID</th><th class="border p-2">TotalOrders</th><th class="border p-2">SuccessRate</th><th class="border p-2">AvgTime</th><th class="border p-2">Satisfaction</th></tr></thead><tbody><tr><td class="border p-2">GD007</td><td class="border p-2">215</td><td class="border p-2">98.6%</td><td class="border p-2">28 phút</td><td class="border p-2">4.9 / 5</td></tr></tbody></table></div></div>
            <div class="mt-8 flex flex-col sm:flex-row gap-4"><button id="downloadTemplateBtn" class="flex-1 text-center bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition">Tải File Mẫu</button><label for="excel-input" class="flex-1 text-center bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition cursor-pointer">Chọn File Excel</label><input type="file" id="excel-input" class="hidden" accept=".xlsx, .xls"></div>
        </div>
    </div>
    
<script id="data-injection-point" type="application/json"></script>
    
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- STATE & DATABASE ---
    let state = {
        overallKPIs: { totalOrders: null, successRate: null, avgTime: null, satisfaction: null },
        employeeData: {},
        currentView: 'placeholder', 
        currentEmployeeId: null,
        currentFilter: { type: 'none', value: null },
        secondaryFilterKey: 'all',
        sortState: { key: 'name', order: 'asc' },
    };
    const processSteps = [
        { id: 'step-1', name: 'Tiếp nhận đơn' }, { id: 'step-2', name: 'Xử lý kho' }, 
        { id: 'step-3', name: 'Điều phối' }, { id: 'step-4', name: 'Vận chuyển' }, 
        { id: 'step-5', name: 'Giao hàng' }, { id: 'step-6', name: 'Cập nhật' }, 
        { id: 'step-7', name: 'Hậu mãi' }
    ];
    let radarChartInstance = null;
    let comparisonChartInstance = null; 

    // --- DOM ELEMENTS ---
    const dom = {
        mainHeader: document.getElementById('mainHeader'), subHeader: document.getElementById('subHeader'), 
        kpiContainer: document.getElementById('kpi-overview'), employeeSearch: document.getElementById('employeeSearch'), 
        searchDropdownBtn: document.getElementById('searchDropdownBtn'), searchResultsContainer: document.getElementById('searchResults'), 
        employeeDetailView: document.getElementById('employeeDetailView'), placeholderView: document.getElementById('placeholderView'), 
        employeeProfileCard: document.getElementById('employeeProfileCard'), timelineContainer: document.getElementById('timelineContainer'), 
        processTimeline: document.getElementById('processTimeline'), performanceRadarChart: document.getElementById('performanceRadarChart'), 
        actionableInsights: document.getElementById('actionableInsights'), importBtn: document.getElementById('importBtn'), 
        importBtnPlaceholder: document.getElementById('importBtnPlaceholder'), compareAllBtn: document.getElementById('compareAllBtn'), 
        downloadHtmlBtn: document.getElementById('downloadHtmlBtn'), modal: document.getElementById('excelGuideModal'), 
        closeModalBtn: document.getElementById('closeModalBtn'), downloadTemplateBtn: document.getElementById('downloadTemplateBtn'), 
        excelInput: document.getElementById('excel-input'), comparisonView: document.getElementById('comparisonView'), 
        comparisonFilterSelect: document.getElementById('comparisonFilterSelect'), comparisonChart: document.getElementById('comparisonChart'), 
        comparisonChartContainer: document.getElementById('comparisonChartContainer'), comparisonTable: document.getElementById('comparisonTable'), 
        comparisonTableBody: document.getElementById('comparisonTableBody'), comparisonTitle: document.getElementById('comparisonTitle'), 
        clearFilterBtn: document.getElementById('clearFilterBtn'), mainContent: document.getElementById('main-content'),
    };
    
    // --- UTILITY & HELPER FUNCTIONS ---
    const utils = {
        parseFloat: (str) => { 
            if (typeof str !== 'string' && typeof str !== 'number') return NaN; 
            return parseFloat(String(str).replace(/[^0-9.,-]/g, '').replace(',', '.')); 
        },
        getKpiStatus: (type, value, threshold) => { 
            if (value === null || value === undefined) return 'neutral'; 
            const numValue = utils.parseFloat(String(value)); 
            if (isNaN(numValue)) return 'neutral'; 
            switch (type) { 
                case 'successRate': return numValue < 95 ? 'bad' : numValue < 98 ? 'average' : 'good'; 
                case 'avgTime': return numValue > (threshold + 5) ? 'bad' : numValue > threshold ? 'average' : 'good'; 
                case 'satisfaction': return numValue < 4.2 ? 'bad' : numValue < 4.7 ? 'average' : 'good'; 
                default: return 'neutral'; 
            } 
        },
        getPerformanceTag: (emp) => { 
            if (!emp || !emp.kpis) return { text: 'N/A', color: 'gray' }; 
            let score = 0; 
            const overallAvgTime = utils.parseFloat(state.overallKPIs.avgTime); 
            const successStatus = utils.getKpiStatus('successRate', emp.kpis.successRate); 
            if (successStatus === 'good') score++; else if (successStatus === 'bad') score--; 
            if (!isNaN(overallAvgTime)) { 
                const timeStatus = utils.getKpiStatus('avgTime', emp.kpis.avgTime, overallAvgTime); 
                if (timeStatus === 'good') score++; else if (timeStatus === 'bad') score--; 
            } 
            const satisfactionStatus = utils.getKpiStatus('satisfaction', emp.kpis.satisfaction); 
            if (satisfactionStatus === 'good') score++; else if (satisfactionStatus === 'bad') score--; 
            if (emp.problems.length > 2) score--; 
            if (score >= 2) return { text: 'Xuất sắc', color: 'green' }; 
            if (score <= -1) return { text: 'Cần cải thiện', color: 'red' }; 
            return { text: 'Ổn định', color: 'blue' }; 
        }
    };
    
    // --- RENDER FUNCTIONS (Đã được định dạng lại, không thu gọn) ---
    const render = {
        kpis: function(kpis, isOverall = false) {
            dom.kpiContainer.classList.add("transitioning");
            setTimeout(() => {
                const formatValue = (value, fallback = "N/A") => value ?? fallback;
                const overallAvgTimeThreshold = isOverall ? utils.parseFloat(kpis.avgTime) : utils.parseFloat(state.overallKPIs.avgTime);
                const statusColor = (status) => ({good: "green", average: "orange", bad: "red", neutral: "gray"})[status];
                const kpiTitleMap = { totalOrders: "Tổng Đơn", successRate: "Giao thành công", avgTime: "Thời gian giao trung bình", satisfaction: "Đánh giá hài lòng" };
                const kpiData = [
                    { key: "totalOrders", title: "Tổng Đơn Hàng", value: formatValue(kpis.totalOrders), icon: "local_shipping", status: "neutral" },
                    { key: "successRate", title: "Giao Thành Công", value: formatValue(kpis.successRate), icon: "task_alt", status: utils.getKpiStatus("successRate", kpis.successRate) },
                    { key: "avgTime", title: "TG Giao TB", value: formatValue(kpis.avgTime), icon: "timer", status: utils.getKpiStatus("avgTime", kpis.avgTime, overallAvgTimeThreshold) },
                    { key: "satisfaction", title: "Đánh Giá Hài Lòng", value: formatValue(kpis.satisfaction), icon: "star", status: utils.getKpiStatus("satisfaction", kpis.satisfaction) }
                ];
                
                dom.kpiContainer.innerHTML = kpiData.map(kpi => `
                    <div class="kpi-card card flex items-center gap-4" data-kpi-key="${kpi.key}" title="${(isOverall && kpi.key !== 'totalOrders') ? `Lọc nhân viên có ${kpiTitleMap[kpi.key]} thấp` : ''}">
                        <div class="w-12 h-12 rounded-lg flex items-center justify-center bg-${statusColor(kpi.status)}-100">
                            <span class="material-symbols-outlined text-${statusColor(kpi.status)}-600">${kpi.icon}</span>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">${kpi.title}</p>
                            <p class="text-xl font-bold text-gray-800">${kpi.value}</p>
                        </div>
                    </div>`).join("");
                
                dom.kpiContainer.classList.remove("transitioning");
            }, 200);
        },
        timeline: function(employeeId) {
            const problemSteps = state.employeeData[employeeId]?.problems || [];
            dom.processTimeline.innerHTML = processSteps.map(step => `
                <div class="timeline-item ${problemSteps.includes(step.id) ? "problem-highlight" : ""}" data-step-id="${step.id}">
                    <div class="timeline-item-content"><p class="font-medium">${step.name}</p></div>
                </div>`).join("");
        },
        profile: function(employeeId) {
            const employee = state.employeeData[employeeId];
            const tag = utils.getPerformanceTag(employee);
            const tagColor = { green: "bg-green-100 text-green-800", blue: "bg-blue-100 text-blue-800", red: "bg-red-100 text-red-800", gray: "bg-gray-100 text-gray-800" }[tag.color];
            dom.employeeProfileCard.innerHTML = `
                <div class="flex-shrink-0 w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-2xl font-bold">
                    ${employee.name.split(" ").map(n => n[0]).join("").substring(0, 2).toUpperCase()}
                </div>
                <div class="flex-1">
                    <h4 class="text-lg font-bold text-gray-800">${employee.name}</h4>
                    <p class="text-sm text-gray-500">${employee.title}</p>
                    <span class="mt-2 inline-block px-2 py-1 text-xs font-semibold rounded-full ${tagColor}">${tag.text}</span>
                </div>`;
        },
        radarChart: function(employeeId) {
            const employee = state.employeeData[employeeId];
            if (employee && employee.radarScores) {
                const ctx = dom.performanceRadarChart.getContext("2d");
                if (radarChartInstance) radarChartInstance.destroy();
                radarChartInstance = new Chart(ctx, {
                    type: "radar",
                    data: {
                        labels: Object.keys(employee.radarScores),
                        datasets: [{
                            label: employee.name,
                            data: Object.values(employee.radarScores),
                            backgroundColor: "rgba(59, 130, 246, 0.2)",
                            borderColor: "rgba(59, 130, 246, 1)",
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { r: { angleLines: { color: "#e2e8f0" }, grid: { color: "#e2e8f0" }, pointLabels: { font: { size: 13 }, color: "#4a5568" }, ticks: { backdropColor: "white", stepSize: 1 }, suggestedMin: 0, suggestedMax: 5 } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        },
        insights: function(stepId, employeeId) {
            const employee = state.employeeData[employeeId];
            const details = employee?.problemDetails[stepId];
            if (details) {
                dom.actionableInsights.innerHTML = `
                    <div class="card border-2 border-orange-400">
                        <h3 class="text-lg font-bold text-gray-800">${details.title}</h3>
                        <div class="mt-4 bg-red-50 p-4 rounded-lg border border-red-200">
                            <h4 class="font-semibold text-red-700 flex items-center gap-2"><span class="material-symbols-outlined">flag</span>Điểm cần cải thiện</h4>
                            <ul class="list-disc list-inside mt-2 space-y-1 text-red-900">${details.weaknesses.map(w => `<li>${w}</li>`).join("")}</ul>
                        </div>
                        <div class="mt-4">
                            <h4 class="font-semibold text-green-600 flex items-center gap-2"><span class="material-symbols-outlined">lightbulb</span>Gợi ý Hành động</h4>
                            <ul class="list-disc list-inside mt-2 space-y-1 text-gray-600">${details.solutions.map(s => `<li>${s}</li>`).join("")}</ul>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <a href="#" class="text-sm text-blue-600 hover:underline font-semibold" data-action="cross-analyze-step" data-step-id="${stepId}">Xem các nhân viên khác cùng gặp vấn đề này →</a>
                        </div>
                    </div>`;
            } else {
                dom.actionableInsights.innerHTML = `
                    <div class="card bg-green-50 border-2 border-green-300">
                        <h3 class="text-lg font-bold text-green-800 flex items-center gap-2"><span class="material-symbols-outlined">verified</span>Vận hành Tốt</h3>
                        <p class="mt-2 text-green-700">Nhân viên không gặp vấn đề nào được ghi nhận ở bước này. Hoạt động hiệu quả!</p>
                    </div>`;
            }
        },
        comparisonChart: function(employees) {
            if (comparisonChartInstance) comparisonChartInstance.destroy();
            const topEmployees = employees.slice(0, 15);
            const labels = topEmployees.map(e => e.name);
            const datasets = [
                { label: "Tỷ lệ T.Công (%)", data: topEmployees.map(e => utils.parseFloat(e.kpis.successRate)), backgroundColor: "rgba(16, 185, 129, 0.7)" },
                { label: "TG Giao TB (phút)", data: topEmployees.map(e => utils.parseFloat(e.kpis.avgTime)), backgroundColor: "rgba(249, 115, 22, 0.7)" },
                { label: "Đánh Giá (sao)", data: topEmployees.map(e => utils.parseFloat(e.kpis.satisfaction)), backgroundColor: "rgba(239, 68, 68, 0.7)" },
            ];
            const ctx = dom.comparisonChart.getContext("2d");
            comparisonChartInstance = new Chart(ctx, {
                type: "bar", data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: "top" }, title: { display: true, text: `So sánh hiệu suất ${employees.length > 15 ? "(Top 15)" : ""}` } },
                    scales: { x: { ticks: { autoSkip: true, maxRotation: 45, minRotation: 0 } }, y: { stacked: false, title: { display: true, text: "Giá trị" } } }
                }
            });
            dom.comparisonChartContainer.style.display = topEmployees.length > 0 ? "block" : "none";
        },
        comparisonTable: function(employees) {
            const overallAvgTime = utils.parseFloat(state.overallKPIs.avgTime);
            if (employees.length > 0) {
                dom.comparisonTableBody.innerHTML = employees.map(emp => {
                    const tag = utils.getPerformanceTag(emp);
                    const rowClass = tag.color === "red" ? "bg-red-50 hover:bg-red-100" : "hover:bg-gray-50";
                    const statusClass = (type, value) => {
                        const status = utils.getKpiStatus(type, value, overallAvgTime);
                        return status === "bad" ? "text-red-600 font-semibold" : status === "average" ? "text-orange-500" : "text-gray-500";
                    };
                    return `
                        <tr class="${rowClass} cursor-pointer transition-colors" data-employee-id="${emp.id}" title="Click xem chi tiết ${emp.name}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${emp.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${emp.kpis.totalOrders ?? 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass("successRate", emp.kpis.successRate)}">${emp.kpis.successRate ?? 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass("avgTime", emp.kpis.avgTime)}">${emp.kpis.avgTime ?? 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass("satisfaction", emp.kpis.satisfaction)}">${emp.kpis.satisfaction ?? 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${tag.color === 'green' ? 'text-green-600' : tag.color === 'red' ? 'text-red-600' : 'text-blue-600'}">${emp.avgSkill}</td>
                        </tr>`;
                }).join("");
            } else {
                dom.comparisonTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">Không có nhân viên nào phù hợp.</td></tr>`;
            }
        },
        searchDropdown: function(employees, query) {
            if (employees.length > 0) {
                dom.searchResultsContainer.innerHTML = employees.map(emp => {
                    const tag = utils.getPerformanceTag(emp);
                    const warningIcon = tag.color === "red" ? `<span class="material-symbols-outlined text-orange-500 !text-base ml-auto">warning</span>` : "";
                    return `<div class="p-2 cursor-pointer hover:bg-blue-50 flex items-center" data-employee-id="${emp.id}"><span>${emp.name} <span class="text-gray-400">(${emp.id})</span></span> ${warningIcon}</div>`;
                }).join("");
                dom.searchResultsContainer.classList.remove("hidden");
            } else {
                if (query) {
                    dom.searchResultsContainer.innerHTML = `<div class="p-2 text-gray-500 text-sm">Không tìm thấy.</div>`;
                    dom.searchResultsContainer.classList.remove("hidden");
                } else {
                    dom.searchResultsContainer.classList.add("hidden");
                }
            }
        }
    };

    // --- VIEW & STATE MANAGEMENT ---
    function updateView() {
        const { currentView, currentEmployeeId, employeeData } = state;
        const hasData = Object.keys(employeeData).length > 0;

        [dom.compareAllBtn, dom.employeeSearch, dom.downloadHtmlBtn, dom.comparisonFilterSelect].forEach(el => {
            el.disabled = !hasData;
            el.classList.toggle('opacity-50', !hasData);
            el.classList.toggle('cursor-not-allowed', !hasData);
        });

        dom.placeholderView.style.display = 'none';
        dom.employeeDetailView.style.display = 'none';
        dom.comparisonView.classList.add('hidden');
        dom.mainContent.style.display = 'none';

        if (currentView === 'placeholder') {
            dom.mainContent.style.display = 'block';
            dom.placeholderView.style.display = 'block';
            dom.subHeader.textContent = hasData ? "Nơi tổng hợp và phân tích dữ liệu hiệu suất giao hàng." : "Sẵn sàng phân tích dữ liệu giao hàng của bạn.";
            render.kpis(state.overallKPIs, true);
        } else if (currentView === 'detail') {
            const emp = employeeData[currentEmployeeId];
            if (emp) {
                dom.mainContent.style.display = 'block';
                dom.employeeDetailView.style.display = 'block';
                dom.subHeader.textContent = `Chi tiết hiệu suất nhân viên: ${emp.name}`;
                render.kpis(emp.kpis);
                render.profile(currentEmployeeId);
                render.timeline(currentEmployeeId);
                render.radarChart(currentEmployeeId);
                dom.timelineContainer.classList.remove('bg-orange-50', 'border-orange-200', 'bg-green-50', 'border-green-200');
                dom.timelineContainer.classList.add(emp.problems.length > 0 ? 'bg-orange-50' : 'bg-green-50', emp.problems.length > 0 ? 'border-orange-200' : 'border-green-200');
                const firstProblemStep = emp.problems?.[0] || processSteps[0]?.id;
                if (firstProblemStep) {
                    const activeItem = dom.processTimeline.querySelector(`[data-step-id="${firstProblemStep}"]`);
                    if(activeItem) {
                        document.querySelectorAll('.timeline-item.active').forEach(i=>i.classList.remove('active'));
                        activeItem.classList.add('active');
                        render.insights(firstProblemStep, currentEmployeeId);
                    }
                }
            }
        } else if (currentView === 'comparison'){ 
            dom.comparisonView.classList.remove('hidden');
            dom.subHeader.textContent = `So sánh và phân tích hiệu suất giữa các nhân viên.`;
            sortAndRerenderComparison(state.sortState.key, false);
        }
    }
    
    function getFilteredEmployees() {
        let employees = Object.values(state.employeeData);
        let title = "So sánh Hiệu suất Toàn bộ Nhân viên";
        const overallAvgTime = utils.parseFloat(state.overallKPIs.avgTime);

        if (state.currentFilter.type === "kpi") {
            employees = employees.filter(e => utils.getKpiStatus(state.currentFilter.value, e.kpis[state.currentFilter.value], overallAvgTime) === "bad");
            const titleMap = { successRate: "Tỷ lệ Giao hàng thấp", avgTime: "Thời gian Giao hàng cao", satisfaction: "Đánh giá thấp" };
            title = `Nhân viên có ${titleMap[state.currentFilter.value] || "vấn đề KPI"}`;
        } else if (state.currentFilter.type === "step") {
            employees = employees.filter(e => e.problems.includes(state.currentFilter.value));
            const stepName = processSteps.find(s => s.id === state.currentFilter.value)?.name || "Không xác định";
            title = `Nhân viên gặp vấn đề ở bước: ${stepName}`;
        }

        if (state.secondaryFilterKey && state.secondaryFilterKey !== 'all') {
            switch(state.secondaryFilterKey) {
                case "hasProblems": employees = employees.filter(e => e.problems.length > 0); break;
                case "avgSkill": employees = employees.filter(e => parseFloat(e.avgSkill) < 3.5); break;
                default: employees = employees.filter(e => utils.getKpiStatus(state.secondaryFilterKey, e.kpis[state.secondaryFilterKey], overallAvgTime) === 'bad');
            }
        }

        dom.comparisonTitle.textContent = title;
        dom.clearFilterBtn.classList.toggle("hidden", state.currentFilter.type === "none" && state.secondaryFilterKey === 'all');
        return employees;
    }

    function applyFilterAndShowComparison(filter) {
        state.currentFilter = filter;
        state.currentView = 'comparison';
        state.secondaryFilterKey = 'all';
        dom.comparisonFilterSelect.value = 'all';
        state.sortState = filter.type === 'kpi' 
            ? { key: filter.value, order: filter.value === 'avgTime' ? 'desc' : 'asc' }
            : { key: 'name', order: 'asc' };
        updateView();
        dom.comparisonView.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // --- FILE & DATA HANDLING ---
    function processAndLoadData(workbook) {
        try {
            const kpiSheet = XLSX.utils.sheet_to_json(workbook.Sheets.KPIs, { header: 1 });
            const nvSheet = XLSX.utils.sheet_to_json(workbook.Sheets.NhanVien);
            const vdSheet = XLSX.utils.sheet_to_json(workbook.Sheets.VanDe);
            const kpiNvSheet = XLSX.utils.sheet_to_json(workbook.Sheets.KPI_NhanVien);

            state.overallKPIs = kpiSheet && kpiSheet.length > 1 ? {
                totalOrders: String(kpiSheet[1][0] ?? ""), successRate: String(kpiSheet[1][1] ?? ""),
                avgTime: String(kpiSheet[1][2] ?? ""), satisfaction: String(kpiSheet[1][3] ?? "")
            } : {};
            
            const employeeMap = {};
            nvSheet.forEach(row => {
                if (!row.ID) return;
                const id = String(row.ID).trim();
                const scores = { "Tốc độ": Number(row.TocDo||0), "Chính xác": Number(row.ChinhXac||0), "Giao tiếp": Number(row.GiaoTiep||0), "Xử lý VĐ": Number(row.XuLyVanDe||0), "Chủ động": Number(row.ChuDong||0) };
                const validScores = Object.values(scores).filter(s => typeof s === 'number' && !isNaN(s));
                employeeMap[id] = {
                    id: id, name: String(row.Name || ""), title: String(row.Title || "NV Giao hàng"),
                    radarScores: scores, kpis: {}, problems: [], problemDetails: {},
                    avgSkill: validScores.length > 0 ? (validScores.reduce((a, b) => a + b, 0) / validScores.length).toFixed(1) : "N/A"
                };
            });

            vdSheet.forEach(row => {
                const id = String(row.EmployeeID).trim();
                if (employeeMap[id]) {
                    const stepId = String(row.StepID).trim();
                    if (!employeeMap[id].problems.includes(stepId)) employeeMap[id].problems.push(stepId);
                    if (!employeeMap[id].problemDetails[stepId]) {
                        employeeMap[id].problemDetails[stepId] = { title: processSteps.find(s => s.id === stepId)?.name || "Vấn đề khác", weaknesses: [], solutions: [] };
                    }
                    employeeMap[id].problemDetails[stepId].weaknesses.push(String(row.Weakness || ""));
                    employeeMap[id].problemDetails[stepId].solutions.push(String(row.Solution || ""));
                }
            });

            kpiNvSheet.forEach(row => {
                const id = String(row.EmployeeID).trim();
                if (employeeMap[id]) {
                    employeeMap[id].kpis = {
                        totalOrders: String(row.TotalOrders ?? ""), successRate: String(row.SuccessRate ?? ""),
                        avgTime: String(row.AvgTime ?? ""), satisfaction: String(row.Satisfaction ?? "")
                    };
                }
            });

            state.employeeData = employeeMap;
            dom.modal.classList.add("hidden");
            alert("Tải và phân tích dữ liệu thành công!");
            resetToHomeView(true);
        } catch(e) {
            console.error("Lỗi xử lý file Excel:", e);
            alert("Lỗi xử lý dữ liệu từ file Excel. Vui lòng kiểm tra lại cấu trúc file.");
        }
    }
    
    function handleFile(e) {
        const file = e.target.files[0];
        if (file) {
            e.target.value = ""; // Reset input
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const requiredSheets = ["KPIs", "NhanVien", "VanDe", "KPI_NhanVien"];
                const missingSheets = requiredSheets.filter(sheet => !workbook.SheetNames.includes(sheet));
                if (missingSheets.length === 0) {
                    processAndLoadData(workbook);
                } else {
                    alert(`Lỗi! File Excel thiếu các sheet: ${missingSheets.join(", ")}.`);
                }
            };
            reader.readAsArrayBuffer(file);
        }
    }

    function downloadExcelTemplate() {
        const wb = XLSX.utils.book_new();
        const wsData = {
            KPIs: [["TotalOrders", "SuccessRate", "AvgTime", "Satisfaction"], ["1,280", "96.5%", "32 phút", "4.7 / 5"]],
            NhanVien: [["ID", "Name", "Title", "TocDo", "ChinhXac", "GiaoTiep", "XuLyVanDe", "ChuDong"], ["GD001", "Nguyễn Văn A", "NV Giao hàng", 5, 4, 5, 4, 5], ["GD002", "Trần Thị B", "NV Giao hàng", 4, 5, 3, 3, 4]],
            VanDe: [["EmployeeID", "StepID", "Weakness", "Solution"], ["GD002", "step-3", "Chưa tối ưu lộ trình", "Huấn luyện 1-1 về sử dụng bản đồ"], ["GD002", "step-5", "Thái độ chưa niềm nở", "Đào tạo về kỹ năng dịch vụ khách hàng"]],
            KPI_NhanVien: [["EmployeeID", "TotalOrders", "SuccessRate", "AvgTime", "Satisfaction"], ["GD001", "215", "98.6%", "28 phút", "4.9 / 5"], ["GD002", "198", "94.2%", "37 phút", "4.1 / 5"]]
        };
        for (const sheetName in wsData) {
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData[sheetName]), sheetName);
        }
        XLSX.writeFile(wb, "Dashboard_VanHanh_Template.xlsx");
    }

    function sortAndRerenderComparison(key, toggleOrder = true) {
        if (toggleOrder) {
            if (state.sortState.key === key) {
                state.sortState.order = state.sortState.order === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortState = { key, order: 'asc' };
            }
        }
        dom.comparisonTable.querySelectorAll("th[data-sort-key]").forEach(th => th.removeAttribute("data-sort-order"));
        dom.comparisonTable.querySelector(`th[data-sort-key="${key}"]`)?.setAttribute("data-sort-order", state.sortState.order);
        
        const employeesToSort = getFilteredEmployees();
        employeesToSort.sort((a, b) => {
            let valA, valB;
            if (key === 'name') {
                valA = a.name; valB = b.name;
            } else if (key === 'avgSkill') {
                valA = parseFloat(a.avgSkill); valB = parseFloat(b.avgSkill);
            } else {
                valA = utils.parseFloat(a.kpis[key]); valB = utils.parseFloat(b.kpis[key]);
            }

            if (isNaN(valA) || valA === null) return 1;
            if (isNaN(valB) || valB === null) return -1;

            let comparison = valA > valB ? 1 : (valA < valB ? -1 : 0);
            if (key === 'avgTime') comparison *= -1; // Reverse for time (higher is worse)

            return state.sortState.order === 'asc' ? comparison : -comparison;
        });

        render.comparisonTable(employeesToSort);
        render.comparisonChart(employeesToSort);
    }
    
    // --- Báo cáo HTML tự chứa (Self-contained) & Khôi phục ---
    function downloadReport() {
        const today = new Date().toISOString().slice(0, 10);
        let fileName = prompt("Nhập tên file báo cáo:", `BaoCao_PhanTich_${today}.html`);
        if (!fileName) return; // User cancelled
        if (!fileName.toLowerCase().endsWith('.html')) fileName += '.html';
        
        const fullHtml = document.documentElement.outerHTML;
        const dataToInject = JSON.stringify(state);
        // Thay thế thẻ script rỗng bằng thẻ script chứa dữ liệu. Dùng function để tránh vấn đề với kí tự đặc biệt trong JSON
        const finalHtml = fullHtml.replace(
            /<script id="data-injection-point" type="application\/json"><\/script>/,
            () => `<script id="data-injection-point" type="application/json">${dataToInject}<\/script>`
        );
        
        const blob = new Blob([finalHtml], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    function resetToHomeView(keepData = false) {
        state.currentView = "placeholder";
        state.currentEmployeeId = null;
        state.currentFilter = { type: 'none', value: null };
        state.secondaryFilterKey = 'all';
        dom.comparisonFilterSelect.value = 'all';
        dom.employeeSearch.value = "";
        
        if (!keepData) {
            state.overallKPIs = { totalOrders: null, successRate: null, avgTime: null, satisfaction: null };
            state.employeeData = {};
        }
        updateView();
    }
    
    function loadStateFromHTML(injectedState) {
        state = { ...state, ...injectedState }; // Ghi đè state hiện tại
        dom.comparisonFilterSelect.value = state.secondaryFilterKey || 'all'; 
        updateView(); // Cập nhật toàn bộ UI
    }
    
    // --- EVENT LISTENERS ---
    dom.importBtn.addEventListener('click', () => dom.modal.classList.remove('hidden')); 
    dom.importBtnPlaceholder.addEventListener('click', () => dom.modal.classList.remove('hidden')); 
    dom.closeModalBtn.addEventListener('click', () => dom.modal.classList.add('hidden')); 
    dom.downloadTemplateBtn.addEventListener('click', downloadExcelTemplate); 
    dom.excelInput.addEventListener('change', handleFile); 
    dom.downloadHtmlBtn.addEventListener('click', () => { if(!dom.downloadHtmlBtn.disabled) downloadReport(); });
    dom.mainHeader.querySelector('h1').addEventListener('click', () => { if(Object.keys(state.employeeData).length > 0) resetToHomeView(true); });
    
    dom.employeeSearch.addEventListener('input', (e) => { 
        const q = e.target.value.toLowerCase().trim();
        if(Object.keys(state.employeeData).length === 0) return;
        const results = q.length === 0 
            ? Object.values(state.employeeData).sort((a,b) => a.name.localeCompare(b.name)) 
            : Object.values(state.employeeData).filter(emp => emp.name.toLowerCase().includes(q) || emp.id.toLowerCase().includes(q));
        render.searchDropdown(results, q); 
    });
    dom.searchDropdownBtn.addEventListener('click', (e) => { 
        e.stopPropagation();
        if(dom.searchResultsContainer.classList.contains('hidden')) {
            const allEmployees = Object.values(state.employeeData).sort((a,b) => a.name.localeCompare(b.name));
            render.searchDropdown(allEmployees);
        } else {
            dom.searchResultsContainer.classList.add('hidden');
        }
    });
    document.addEventListener('click', (e) => { 
        if (!dom.employeeSearchContainer.contains(e.target)) dom.searchResultsContainer.classList.add('hidden'); 
    });
    dom.searchResultsContainer.addEventListener('click', (e) => { 
        const target = e.target.closest('[data-employee-id]');
        if(target){ 
            state.currentEmployeeId = target.dataset.employeeId;
            state.currentView = 'detail';
            dom.employeeSearch.value = state.employeeData[state.currentEmployeeId].name;
            dom.searchResultsContainer.classList.add('hidden');
            updateView(); 
            dom.mainContent.scrollIntoView({ behavior: 'smooth' }); 
        } 
    });
    dom.processTimeline.addEventListener('click', (e) => {
        const item = e.target.closest('.timeline-item');
        if(item && state.currentView === 'detail'){ 
            document.querySelectorAll('.timeline-item.active').forEach(i => i.classList.remove('active'));
            item.classList.add('active'); 
            render.insights(item.dataset.stepId, state.currentEmployeeId);
        }
    });
    dom.actionableInsights.addEventListener('click', (e) => { 
        const link = e.target.closest('[data-action="cross-analyze-step"]'); 
        if(link){ 
            e.preventDefault();
            applyFilterAndShowComparison({type: 'step', value: link.dataset.stepId}); 
        } 
    });
    dom.compareAllBtn.addEventListener('click', () => { 
        if (!dom.compareAllBtn.disabled) applyFilterAndShowComparison({type: 'none', value: null}); 
    });
    dom.clearFilterBtn.addEventListener('click', () => dom.compareAllBtn.click());
    dom.kpiContainer.addEventListener('click', (e) => {
        const card = e.target.closest('.kpi-card'); 
        if(card && card.dataset.kpiKey !== 'totalOrders' && state.currentView === 'placeholder') {
            applyFilterAndShowComparison({type: 'kpi', value: card.dataset.kpiKey}); 
        }
    });
    dom.comparisonTable.querySelector('thead').addEventListener('click', (e) => { 
        const header = e.target.closest('th[data-sort-key]'); 
        if(header) sortAndRerenderComparison(header.dataset.sortKey); 
    });
    dom.comparisonTableBody.addEventListener('click', (e) => { 
        const row = e.target.closest('tr[data-employee-id]'); 
        if(row){ 
            state.currentEmployeeId = row.dataset.employeeId; 
            state.currentView = 'detail'; 
            dom.employeeSearch.value = state.employeeData[state.currentEmployeeId].name; 
            updateView(); 
            dom.mainContent.scrollIntoView({behavior:'smooth'}); 
        }
    });
    dom.comparisonFilterSelect.addEventListener('change', (e) => { 
        state.secondaryFilterKey = e.target.value; 
        sortAndRerenderComparison(state.sortState.key, false); 
    });
    
    const scrollToTopBtn = document.createElement("button");
    scrollToTopBtn.id = "scrollToTopBtn";
    scrollToTopBtn.className = "fixed bottom-8 right-8 bg-blue-500 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg z-20";
    scrollToTopBtn.innerHTML = '<span class="material-symbols-outlined !text-2xl">arrow_upward</span>';
    document.body.appendChild(scrollToTopBtn);
    window.onscroll = () => { scrollToTopBtn.classList.toggle("visible", document.body.scrollTop > 300 || document.documentElement.scrollTop > 300); };
    scrollToTopBtn.addEventListener("click", () => { window.scrollTo({ top: 0, behavior: "smooth" }); });

    // --- KHỞI TẠO ỨNG DỤNG ---
    function initializeApp() {
        const injectedDataEl = document.getElementById('data-injection-point');
        if (injectedDataEl && injectedDataEl.textContent.trim().length > 2) {
            try {
                loadStateFromHTML(JSON.parse(injectedDataEl.textContent));
                // Thông báo chỉ hiển thị một lần, tránh làm phiền khi reload
                if (!window.sessionStorage.getItem('reportLoaded')) {
                    alert("Đã tải báo cáo từ file HTML thành công!");
                    window.sessionStorage.setItem('reportLoaded', 'true');
                }
            } catch(e) {
                console.error("Không thể đọc dữ liệu nhúng.", e);
                alert("Lỗi khi đọc dữ liệu từ báo cáo. Vui lòng thử lại.");
                resetToHomeView();
            }
        } else {
            resetToHomeView();
        }
    }
    
    initializeApp();
});
</script>
</body>
</html>